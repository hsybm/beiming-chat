<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒ—</title>
    <!-- Font Awesome å›¾æ ‡åº“ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ==================== åŸºç¡€æ ·å¼ ==================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --wechat-green: #07c160;      /* å¾®ä¿¡ç»¿ */
            --wechat-bg: #ededed;         /* å¾®ä¿¡èƒŒæ™¯ç° */
            --wechat-bubble-ai: #ffffff;  /* AIæ°”æ³¡ç™½ */
            --wechat-bubble-user: #95ec69;/* ç”¨æˆ·æ°”æ³¡ç»¿ */
            --wechat-text-dark: #000000;
            --wechat-text-light: #888888;
            --wechat-border: #e5e5e5;
            --wechat-radius: 6px;         /* æ°”æ³¡åœ†è§’ */
            --wechat-avatar-radius: 6px;  /* å¤´åƒæ–¹å½¢åœ†è§’ */
            --settings-width: 320px;      /* è®¾ç½®é¢æ¿å®½åº¦ */
            --transition-speed: 0.3s;     /* è¿‡æ¸¡é€Ÿåº¦ */
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 
                         "Segoe UI", "PingFang SC", "Hiragino Sans GB", 
                         "Microsoft YaHei", sans-serif;
            background: var(--wechat-bg);
            height: 100vh;
            color: var(--wechat-text-dark);
            overflow: hidden;
            position: relative;
        }

        /* ==================== ä¸»å®¹å™¨ ==================== */
        .main-container {
            display: flex;
            width: 100%;
            height: 100vh;
            position: relative;
            overflow: hidden;
            transition: transform var(--transition-speed) ease;
        }

        /* èŠå¤©é¡µé¢ */
        .chat-page {
            flex: 1;
            min-width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            background: white;
            position: relative;
            transition: transform var(--transition-speed) ease;
        }

        /* è®¾ç½®é¡µé¢ä¾§æ»‘æ•ˆæœ */
        .settings-open .chat-page {
            transform: translateX(calc(-1 * var(--settings-width)));
            box-shadow: 5px 0 15px rgba(0,0,0,0.1);
        }

        /* ==================== å¾®ä¿¡é¡¶éƒ¨å¯¼èˆª ==================== */
        .wechat-header {
            background: var(--wechat-green);
            padding: 10px 15px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
            flex-shrink: 0;
            z-index: 100;
        }

        .wechat-header .header-left,
        .wechat-header .header-right {
            width: 40px;
            display: flex;
            align-items: center;
        }

        .wechat-header .header-center {
            flex: 1;
            text-align: center;
            font-size: 17px;
            font-weight: 500;
            color: white;
            letter-spacing: 0.5px;
        }

        .wechat-header .back-btn {
            color: white;
            font-size: 18px;
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: background 0.2s;
        }

        .wechat-header .back-btn:hover {
            background: rgba(255,255,255,0.1);
        }

        /* ==================== å¾®ä¿¡èŠå¤©å†…å®¹åŒº ==================== */
        .wechat-chat-content {
            flex: 1;
            padding: 10px;
            background: var(--wechat-bg);
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" opacity="0.03"><path d="M50,0 L100,50 L50,100 L0,50 Z" fill="%23000000"/></svg>');
            background-size: 100px;
            overflow-y: auto;
            scroll-behavior: smooth;
            display: flex;
            flex-direction: column;
            min-height: 0;
            position: relative;
        }

        /* èŠå¤©èƒŒæ™¯è¦†ç›–å±‚ */
        .chat-bg-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-size: cover;
            background-position: center;
            opacity: 0.1;
            pointer-events: none;
            z-index: 0;
        }

        /* èŠå¤©å†…å®¹åŒºï¼ˆåœ¨èƒŒæ™¯ä¹‹ä¸Šï¼‰ */
        .chat-content-wrapper {
            position: relative;
            z-index: 1;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        /* å¾®ä¿¡æ—¶é—´æ ‡ç­¾ */
        .wechat-time-tag {
            text-align: center;
            color: var(--wechat-text-light);
            font-size: 12px;
            margin: 20px auto;
            padding: 5px 15px;
            background: rgba(0,0,0,0.1);
            border-radius: 15px;
            display: inline-block;
            align-self: center;
        }

        /* ==================== å¾®ä¿¡å¤´åƒæ ·å¼ ==================== */
        .wechat-avatar {
            width: 38px;
            height: 38px;
            border-radius: var(--wechat-avatar-radius);
            overflow: hidden;
            flex-shrink: 0;
            border: 1px solid rgba(0,0,0,0.1);
            align-self: flex-start;
            margin-top: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            font-weight: bold;
            position: relative;
        }

        .wechat-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .avatar-default-icon {
            font-size: 20px;
        }

        /* ==================== å¾®ä¿¡æ°”æ³¡æ ·å¼ï¼ˆä¿®å¤ç‰ˆï¼‰ ==================== */
        .message {
            display: flex;
            margin-bottom: 15px;
            position: relative;
            max-width: 100%;
            animation: messageIn 0.3s ease;
        }

        @keyframes messageIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* AIæ¶ˆæ¯ï¼šé å·¦å¯¹é½ */
        .message-ai {
            justify-content: flex-start;
        }

        /* ç”¨æˆ·æ¶ˆæ¯ï¼šé å³å¯¹é½ */
.message-user {
    justify-content: flex-end; /* è¿™è¡Œä¿è¯ç”¨æˆ·æ¶ˆæ¯æ•´ä½“åœ¨å³è¾¹ */
}

        /* æ¶ˆæ¯å†…å®¹å®¹å™¨ - ä¿®å¤å¸ƒå±€ */
        .message-content-wrapper {
            display: flex;
            align-items: flex-start;
            max-width: 75%;
            position: relative;
        }

        /* AIæ¶ˆæ¯å¸ƒå±€ï¼šå¤´åƒåœ¨å·¦ï¼Œæ°”æ³¡åœ¨å³ */
        .message-ai .message-content-wrapper {
            flex-direction: row;
        }

        /* ç”¨æˆ·æ¶ˆæ¯å¸ƒå±€ï¼šå¤´åƒåœ¨å³ï¼Œæ°”æ³¡åœ¨å·¦  */
        .message-user .message-content-wrapper {
            flex-direction: row-reverse;
        }

        /* å¾®ä¿¡æ°”æ³¡åŸºç¡€æ ·å¼ */
        .message-bubble {
            max-width: 100%;
            padding: 10px 14px;
            line-height: 1.4;
            font-size: 16px;
            position: relative;
            word-wrap: break-word;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            min-width: 40px;
            border: 1px solid rgba(0,0,0,0.05);
            border-radius: var(--wechat-radius);
            white-space: pre-wrap;
        }

        /* AIæ°”æ³¡ï¼ˆç™½è‰²ï¼‰- å·¦ä¸Šè§’æœ‰å°å°–å°– */
        .message-ai .message-bubble {
            background: var(--wechat-bubble-ai);
            color: var(--wechat-text-dark);
            border-top-left-radius: 4px;
            border-bottom-left-radius: var(--wechat-radius);
            border-bottom-right-radius: var(--wechat-radius);
            border-top-right-radius: var(--wechat-radius);
            margin-left: 12px;
            margin-right: 10px;
        }

        /* AIæ°”æ³¡å°å°–å°–ï¼ˆæŒ‡å‘å·¦è¾¹çš„å¤´åƒï¼‰ */
        .message-ai .message-bubble::before {
            content: '';
            position: absolute;
            left: -10px;
            top: 10px;
            width: 0;
            height: 0;
            border-top: 8px solid transparent;
            border-bottom: 8px solid transparent;
            border-right: 10px solid var(--wechat-bubble-ai);
            border-left: 0;
            z-index: 1;
        }

        /* AIæ°”æ³¡å°å°–å°–çš„é˜´å½± */
        .message-ai .message-bubble::after {
            content: '';
            position: absolute;
            left: -10px;
            top: 10px;
            width: 0;
            height: 0;
            border-top: 8px solid transparent;
            border-bottom: 8px solid transparent;
            border-right: 10px solid rgba(0,0,0,0.1);
            border-left: 0;
            z-index: 0;
            filter: blur(1px);
        }

        /* ç”¨æˆ·æ°”æ³¡ï¼ˆç»¿è‰²ï¼‰- å³ä¸Šè§’æœ‰å°å°–å°– */
        .message-user .message-bubble {
            background: var(--wechat-bubble-user);
            color: #000000;
            border-top-right-radius: 4px;
            border-bottom-left-radius: var(--wechat-radius);
            border-bottom-right-radius: var(--wechat-radius);
            border-top-left-radius: var(--wechat-radius);
            margin-right: 12px;
            margin-left: 10px;
        }

        /* ç”¨æˆ·æ°”æ³¡å°å°–å°–ï¼ˆæŒ‡å‘å³è¾¹çš„å¤´åƒï¼‰ */
        .message-user .message-bubble::before {
            content: '';
            position: absolute;
            right: -10px;
            top: 10px;
            width: 0;
            height: 0;
            border-top: 8px solid transparent;
            border-bottom: 8px solid transparent;
            border-left: 10px solid var(--wechat-bubble-user);
            border-right: 0;
            z-index: 1;
        }

        /* ç”¨æˆ·æ°”æ³¡å°å°–å°–çš„é˜´å½± */
        .message-user .message-bubble::after {
            content: '';
            position: absolute;
            right: -10px;
            top: 10px;
            width: 0;
            height: 0;
            border-top: 8px solid transparent;
            border-bottom: 8px solid transparent;
            border-left: 10px solid rgba(0,0,0,0.1);
            border-right: 0;
            z-index: 0;
            filter: blur(1px);
        }

        /* å›¾ç‰‡æ¶ˆæ¯æ ·å¼ */
        .message-image {
            max-width: 220px;
            max-height: 300px;
            border-radius: var(--wechat-radius);
            margin: 8px 0;
            cursor: pointer;
            transition: transform 0.2s;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: block;
            border: 1px solid rgba(0, 0, 0, 0.08);
        }

        .message-image:hover {
            transform: scale(1.02);
        }

        /* è¡¨æƒ…åŒ…æ¶ˆæ¯æ ·å¼ */
        .sticker-message {
            max-width: 150px;
            max-height: 150px;
            border-radius: 5px;
            display: block;
        }

        .sticker-keyword {
            font-size: 12px;
            color: #666;
            text-align: center;
            margin-top: 5px;
        }

        /* ==================== å¾®ä¿¡è¾“å…¥åŒºåŸŸ ==================== */
        .wechat-input-area {
            background: white;
            padding: 10px 15px;
            border-top: 1px solid var(--wechat-border);
            display: flex;
            align-items: center;
            gap: 8px;
            position: relative;
            min-height: 56px;
            flex-shrink: 0;
            z-index: 100;
        }

        /* è¾“å…¥æ¡†åŒ…è£… */
        .wechat-input-wrapper {
            flex: 1;
            position: relative;
            min-width: 0;
        }

        /* å¾®ä¿¡è¾“å…¥æ¡† */
        .wechat-input {
            width: 100%;
            padding: 8px 15px;
            border: 1px solid var(--wechat-border);
            border-radius: 18px;
            font-size: 16px;
            background: #f0f0f0;
            outline: none;
            transition: all 0.2s;
            min-width: 0;
        }

        .wechat-input:focus {
            background: white;
            border-color: var(--wechat-green);
        }

        .wechat-input::placeholder {
            color: #999;
        }

        /* å¾®ä¿¡æŒ‰é’®æ ·å¼ */
        .wechat-btn {
            padding: 8px 16px;
            background: var(--wechat-green);
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            flex-shrink: 0;
            transition: all 0.2s;
            min-width: 60px;
            text-align: center;
        }

        .wechat-btn:hover {
            background: #06ad56;
            transform: translateY(-1px);
        }

        .wechat-btn:active {
            transform: translateY(0);
        }

        .wechat-btn:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none !important;
        }

        /* å°åœ†å½¢æŒ‰é’® */
        .wechat-icon-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            background: transparent;
            color: #555;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.2s;
        }

        .wechat-icon-btn:hover {
            background: #f0f0f0;
        }

        /* å‘é€æŒ‰é’® */
        .wechat-send-btn {
            padding: 8px 16px;
            background: var(--wechat-green);
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            flex-shrink: 0;
            transition: all 0.2s;
            min-width: 60px;
            text-align: center;
        }

        .wechat-send-btn:hover {
            background: #06ad56;
        }

        /* ==================== APIå¯†é’¥è¾“å…¥æ æ ·å¼ ==================== */
        .api-key-bar {
            background: linear-gradient(to right, #2c3e50, #4a6491);
            color: white;
            padding: 12px 20px;
            font-size: 14px;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 9999;
            position: sticky;
            top: 0;
            width: 100%;
            transition: all 0.3s ease;
        }

        .api-key-container {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
            max-width: 900px;
            width: 100%;
        }

        .api-key-label {
            font-weight: bold;
            white-space: nowrap;
        }

        .api-key-input {
            flex-grow: 1;
            min-width: 200px;
            padding: 10px 15px;
            border: 2px solid #07c160;
            border-radius: 20px;
            background: rgba(255,255,255,0.9);
            font-size: 14px;
            outline: none;
            transition: all 0.3s;
        }

        .api-key-input:focus {
            background: white;
            box-shadow: 0 0 10px rgba(7, 193, 96, 0.5);
        }

        .api-key-btn {
            padding: 10px 20px;
            background: #07c160;
            color: white;
            border: none;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .api-key-btn:hover {
            background: #06ad56;
            transform: translateY(-1px);
        }

        .api-key-status {
            font-size: 13px;
            color: #95ec69;
            min-width: 120px;
            text-align: center;
            font-weight: bold;
        }

        /* ==================== è®¾ç½®é¡µé¢æ ·å¼ ==================== */
        .settings-page {
            width: var(--settings-width);
            height: 100%;
            background: white;
            position: absolute;
            right: calc(-1 * var(--settings-width));
            top: 0;
            overflow-y: auto;
            box-shadow: -5px 0 15px rgba(0,0,0,0.1);
            z-index: 1000;
            transition: right var(--transition-speed) ease;
            display: flex;
            flex-direction: column;
        }

        .settings-open .settings-page {
            right: 0;
        }

        .settings-header {
            background: #2c3e50;
            color: white;
            padding: 20px 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }

        .settings-header h2 {
            font-size: 18px;
            font-weight: 500;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .settings-header h2 i {
            font-size: 20px;
        }

        .close-settings-btn {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .close-settings-btn:hover {
            background: rgba(255,255,255,0.1);
        }

        .settings-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        /* ==================== è®¾ç½®å¡ç‰‡æ ·å¼ ==================== */
        .setting-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #f0f0f0;
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-title i {
            color: var(--wechat-green);
            font-size: 18px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-label {
            display: block;
            font-size: 14px;
            color: #555;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .input-label i {
            margin-right: 8px;
            color: #777;
        }

        .input-field {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e5e5e5;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            transition: all 0.2s;
            outline: none;
        }

        .input-field:focus {
            border-color: var(--wechat-green);
            box-shadow: 0 0 0 3px rgba(7, 193, 96, 0.1);
        }

        textarea.input-field {
            min-height: 100px;
            resize: vertical;
        }

        select.input-field {
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 16px;
            padding-right: 40px;
        }

        /* ==================== å¤´åƒä¸Šä¼ æ ·å¼ ==================== */
        .avatar-section {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .avatar-upload {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .avatar-preview {
            width: 80px;
            height: 80px;
            border-radius: 10px;
            overflow: hidden;
            border: 2px solid #e5e5e5;
            background: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .avatar-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .avatar-upload-btns {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .avatar-upload-btn {
            padding: 10px 15px;
            background: #f8f9fa;
            border: 2px solid #e5e5e5;
            border-radius: 8px;
            color: #555;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .avatar-upload-btn:hover {
            background: #e9ecef;
            border-color: #d0d7de;
        }

        .avatar-upload-btn i {
            font-size: 16px;
        }

        .avatar-color-row {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 10px;
        }

        .color-label {
            min-width: 100px;
            font-size: 14px;
            color: #666;
        }

        .color-picker-input {
            width: 40px;
            height: 40px;
            border: 2px solid #e5e5e5;
            border-radius: 8px;
            cursor: pointer;
            padding: 0;
            background: none;
        }

        .color-preview {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 2px solid #fff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        /* ==================== èƒŒæ™¯é€‰æ‹©æ ·å¼ ==================== */
        .bg-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .bg-option {
            aspect-ratio: 1;
            border-radius: 8px;
            border: 2px solid transparent;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transition: all 0.2s;
        }

        .bg-option:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .bg-option.selected {
            border-color: var(--wechat-green);
            box-shadow: 0 0 0 3px rgba(7, 193, 96, 0.2);
        }

        .bg-check {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 20px;
            height: 20px;
            background: var(--wechat-green);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .bg-option.selected .bg-check {
            opacity: 1;
        }

        /* è‡ªå®šä¹‰èƒŒæ™¯ä¸Šä¼ æŒ‰é’® */
        .bg-custom-upload {
            background: #f8f9fa;
            border: 2px dashed #d0d7de;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .bg-custom-upload i {
            font-size: 24px;
            color: var(--wechat-green);
        }

        .bg-custom-upload span {
            font-size: 12px;
            color: #666;
        }

        /* ==================== è¡¨æƒ…åŒ…ç®¡ç†æ ·å¼ ==================== */
        .sticker-type-select {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .sticker-type-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid #e5e5e5;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 14px;
            color: #555;
        }

        .sticker-type-btn.active {
            background: #2c3e50;
            color: white;
            border-color: #2c3e50;
        }

        .sticker-upload-area {
            padding: 30px 20px;
            border: 2px dashed #d0d7de;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 15px;
            background: #fafafa;
            cursor: pointer;
            transition: all 0.3s;
        }

        .sticker-upload-area:hover {
            border-color: var(--wechat-green);
            background: #f0fff4;
        }

        .sticker-upload-icon {
            font-size: 36px;
            color: var(--wechat-green);
            margin-bottom: 10px;
        }

        .sticker-upload-text {
            color: #666;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .sticker-upload-hint {
            color: #999;
            font-size: 12px;
        }

        .sticker-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            gap: 10px;
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 8px;
            background: white;
        }

        .sticker-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #eee;
            cursor: pointer;
            transition: all 0.3s;
            aspect-ratio: 1;
        }

        .sticker-item:hover {
            transform: scale(1.05);
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            border-color: var(--wechat-green);
        }

        .sticker-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .sticker-item .delete-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 20px;
            height: 20px;
            background: rgba(231, 76, 60, 0.9);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s;
            border: none;
        }

        .sticker-item:hover .delete-btn {
            opacity: 1;
        }

        .empty-sticker {
            grid-column: 1 / -1;
            text-align: center;
            padding: 30px 20px;
            color: #999;
        }

        .empty-sticker i {
            font-size: 36px;
            color: #ddd;
            margin-bottom: 10px;
        }

        /* ==================== åº•éƒ¨æ“ä½œæŒ‰é’® ==================== */
        .bottom-actions {
            padding: 20px;
            background: white;
            border-top: 1px solid #e5e5e5;
            display: flex;
            gap: 15px;
            flex-shrink: 0;
            z-index: 100;
        }

        .save-settings-btn {
            flex: 1;
            padding: 15px;
            background: var(--wechat-green);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .save-settings-btn:hover {
            background: #06ad56;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(7, 193, 96, 0.3);
        }

        .save-settings-btn:active {
            transform: translateY(0);
        }

        /* ==================== è¡¨æƒ…åŒ…é¢æ¿æ ·å¼ ==================== */
        .emoji-panel {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 320px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.15);
            padding: 0;
            z-index: 1000;
            display: none;
            overflow: hidden;
            max-height: 450px;
        }

        .emoji-panel.show {
            display: block;
            animation: slideUp 0.2s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .sticker-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid var(--wechat-border);
            background: #f9f9f9;
        }

        .sticker-panel-tabs {
            display: flex;
            gap: 10px;
        }

        .sticker-panel-tab {
            padding: 8px 12px;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            color: var(--wechat-text-light);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .sticker-panel-tab.active {
            color: var(--wechat-green);
            border-bottom-color: var(--wechat-green);
        }

        .sticker-panel-content {
            padding: 15px;
            max-height: 350px;
            overflow-y: auto;
        }

        .sticker-panel-tab-content {
            display: none;
        }

        .sticker-panel-tab-content.active {
            display: block;
        }

        /* ==================== åŠ è½½åŠ¨ç”» ==================== */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 10px 14px;
            background: white;
            border-radius: var(--wechat-radius);
            border-top-left-radius: 4px;
            width: fit-content;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: #888;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        /* ==================== é”™è¯¯æç¤º ==================== */
        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 10px 14px;
            border-radius: var(--wechat-radius);
            border: 1px solid #ffcdd2;
            margin: 10px;
            text-align: center;
            font-size: 14px;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ==================== Toastæç¤º ==================== */
        .beiming-toast {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 9999;
            pointer-events: none;
            transition: opacity 0.3s ease;
            animation: toastIn 0.3s ease;
        }

        @keyframes toastIn {
            from {
                opacity: 0;
                transform: translate(-50%, -40%);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%);
            }
        }

        /* ==================== æ»šåŠ¨æ¡æ ·å¼ ==================== */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(0,0,0,0.2);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(0,0,0,0.3);
        }

        /* ==================== å“åº”å¼è°ƒæ•´ ==================== */
        @media (max-width: 768px) {
            :root {
                --settings-width: 100%;
            }
            
            .api-key-container {
                flex-direction: column;
                gap: 10px;
            }
            
            .api-key-input {
                min-width: 100%;
            }
            
            .bg-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .emoji-panel {
                width: 280px;
                right: 10px;
            }
            
            .settings-page {
                box-shadow: none;
            }
            
            .settings-open .chat-page {
                transform: translateX(-100%);
            }
        }

        @media (max-width: 480px) {
            .wechat-chat-content {
                padding: 8px;
            }
            
            .message-bubble {
                max-width: 85%;
                padding: 8px 12px;
                font-size: 15px;
            }
            
            .avatar-upload {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .avatar-upload-btns {
                width: 100%;
            }
            
            .emoji-panel {
                width: calc(100% - 20px);
                right: 10px;
            }
        }
        /* ==================== è¡¨æƒ…åŒ…å¿«æ·ä¸Šä¼ é¢æ¿ ==================== */
        #stickerQuickUploadContainer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        .quick-upload-panel {
            width: 90%;
            max-width: 400px;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            animation: slideUp 0.3s ease;
        }
        .panel-header {
            padding: 18px 20px;
            background: #2c3e50;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 16px;
            font-weight: 600;
        }
        .close-panel-btn {
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .close-panel-btn:hover {
            background: rgba(255,255,255,0.1);
        }
        .panel-body {
            padding: 20px;
        }
        .panel-body .input-group {
            margin-bottom: 20px;
        }
        .panel-body label {
            display: block;
            font-size: 14px;
            color: #555;
            margin-bottom: 8px;
            font-weight: 500;
        }
        .panel-body input {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            box-sizing: border-box;
        }
        .panel-body input:focus {
            outline: none;
            border-color: #9b59b6;
        }
        .input-hint {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
        }
        .upload-area {
            border: 2px dashed #d0d7de;
            border-radius: 10px;
            padding: 30px 20px;
            text-align: center;
            cursor: pointer;
            margin: 20px 0;
            background: #fafafa;
            transition: all 0.3s;
        }
        .upload-area:hover {
            border-color: #9b59b6;
            background: #f5f0fa;
        }
        .upload-area i {
            font-size: 36px;
            color: #9b59b6;
            margin-bottom: 10px;
        }
        .upload-area .hint {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }
        .panel-actions {
            display: flex;
            gap: 12px;
        }
        .panel-btn {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border: 2px solid transparent;
        }
        .panel-btn.cancel {
            background: #f8f8f8;
            border-color: #e0e0e0;
            color: #555;
        }
        .panel-btn.save {
            background: #9b59b6;
            color: white;
        }
        .panel-btn.save:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        /* ==================== å›¾ç‰‡é¢„è§ˆå®¹å™¨ ==================== */
        .image-preview-container {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 380px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            overflow: hidden;
            animation: slideUp 0.3s ease;
            display: none;
        }

        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: #f9f9f9;
            border-bottom: 1px solid var(--wechat-border);
        }

        .preview-header span {
            font-weight: 600;
            color: var(--wechat-text-dark);
            font-size: 16px;
        }

        .close-preview-btn {
            background: none;
            border: none;
            color: var(--wechat-text-light);
            font-size: 18px;
            cursor: pointer;
            padding: 5px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .close-preview-btn:hover {
            background: #f0f0f0;
            color: #ff3b30;
        }

        .preview-image {
            width: 100%;
            max-height: 300px;
            object-fit: contain;
            display: block;
            padding: 20px;
            background: linear-gradient(45deg, #f5f7fa 0%, #c3cfe2 100%);
        }

        .preview-info {
            padding: 12px 20px;
            border-top: 1px solid var(--wechat-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f9f9f9;
        }

        .preview-filename {
            font-size: 14px;
            color: var(--wechat-text-dark);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 70%;
            font-weight: 500;
        }

        .preview-size {
            font-size: 12px;
            color: var(--wechat-text-light);
            font-weight: 400;
        }

        .preview-actions {
            display: flex;
            padding: 20px;
            gap: 12px;
            background: white;
        }

        .preview-cancel-btn {
            flex: 1;
            padding: 12px;
            background: #f8f8f8;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            color: var(--wechat-text-dark);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .preview-cancel-btn:hover {
            background: #f0f0f0;
            border-color: #d0d0d0;
        }

        .preview-send-btn {
            flex: 2;
            padding: 12px;
            background: var(--wechat-green);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(7, 193, 96, 0.3);
        }

        .preview-send-btn:hover {
            background: #06ad56;
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(7, 193, 96, 0.4);
        }

        /* ==================== åŠ å·èœå• ==================== */
        .wechat-plus-menu {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 300px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.15);
            padding: 15px;
            z-index: 1000;
            animation: slideUp 0.2s ease;
            display: none;
        }

        .wechat-plus-menu.show {
            display: block;
        }

        .plus-menu-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }

        .plus-menu-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            padding: 10px 5px;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .plus-menu-item:hover {
            background: #f5f5f5;
        }

        .plus-menu-icon {
            width: 48px;
            height: 48px;
            border-radius: 10px;
            background: var(--wechat-green);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            margin-bottom: 8px;
        }

        .plus-menu-text {
            font-size: 12px;
            color: var(--wechat-text-dark);
            text-align: center;
            line-height: 1.3;
        }

        .plus-menu-pagination {
            display: flex;
            justify-content: center;
            gap: 6px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--wechat-border);
        }

        .page-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #ccc;
            transition: all 0.2s;
        }

        .page-dot.active {
            background: var(--wechat-green);
            transform: scale(1.2);
        }
                /* ==================== å›¾ç‰‡æè¿°è¾“å…¥æ¡†æ ·å¼ ==================== */
        .preview-description {
            padding: 15px 20px;
            background: white;
            border-bottom: 1px solid var(--wechat-border);
        }
        .preview-description label {
            display: block;
            font-size: 14px;
            color: var(--wechat-text-dark);
            margin-bottom: 8px;
            font-weight: 500;
        }
        #imageDescription {
            width: 100%;
            padding: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            resize: vertical;
            font-family: inherit;
            box-sizing: border-box;
        }
        #imageDescription:focus {
            outline: none;
            border-color: var(--wechat-green);
            box-shadow: 0 0 0 2px rgba(7, 193, 96, 0.1);
        }
    </style>
</head>
<body>
    <!-- ä¸»å®¹å™¨ -->
    <div class="main-container" id="mainContainer">
        <!-- èŠå¤©é¡µé¢ -->
        <div class="chat-page" id="chatPage">
            <!-- APIå¯†é’¥è¾“å…¥æ  -->
            <div class="api-key-bar" id="apiKeyBar">
                <div class="api-key-container">
                    <span class="api-key-label">DeepSeek APIå¯†é’¥:</span>
                    <input type="password" id="apiKeyInput" class="api-key-input" 
                           placeholder="è¯·è¾“å…¥ä½ çš„APIå¯†é’¥ (sk-å¼€å¤´)" value="">
                    <button id="apiKeyBtn" class="api-key-btn" onclick="saveApiKey()">ä¿å­˜å¯†é’¥</button>
                    <span id="apiKeyStatus" class="api-key-status">ğŸ”‘ æœªè®¾ç½®</span>
                </div>
            </div>

            <!-- å¾®ä¿¡é¡¶éƒ¨å¯¼èˆª -->
            <div class="wechat-header">
                <div class="header-left">
                    <button class="back-btn" id="settingsToggleBtn">
                        <i class="fas fa-cog"></i>
                    </button>
                </div>
                <div class="header-center" id="aiNameDisplay">
                    ğŸ§¸ åŒ—
                </div>
                <div class="header-right">
                    <span style="color: white; opacity: 0.7;">â‹¯</span>
                </div>
            </div>

            <!-- èŠå¤©å†…å®¹åŒº -->
            <div class="wechat-chat-content" id="chatContent">
                <!-- èŠå¤©èƒŒæ™¯è¦†ç›–å±‚ -->
                <div class="chat-bg-overlay" id="chatBgOverlay"></div>
                
                <!-- èŠå¤©å†…å®¹åŒ…è£…å™¨ -->
                <div class="chat-content-wrapper">
                    <!-- æ—¶é—´æ ‡ç­¾ -->
                    <div class="wechat-time-tag" id="currentTime">ä»Šå¤©</div>
                    
                    <!-- æ¶ˆæ¯ä¼šåŠ¨æ€æ·»åŠ åœ¨è¿™é‡Œ -->
                </div>
            </div>

            <!-- å¾®ä¿¡è¾“å…¥åŒºåŸŸ -->
            <div class="wechat-input-area">
                <!-- è¯­éŸ³æŒ‰é’® -->
                <button class="wechat-icon-btn" id="voiceToggleBtn" title="è¯­éŸ³è¾“å…¥">
                    <i class="fas fa-microphone"></i>
                </button>
                
                <!-- è¾“å…¥æ¡† -->
                <div class="wechat-input-wrapper">
                    <input type="text" class="wechat-input" id="messageInput" 
                           placeholder="è¾“å…¥ä½ æƒ³è¯´çš„è¯..." autocomplete="off">
                </div>
                
                <!-- è¡¨æƒ…æŒ‰é’® -->
                <button class="wechat-icon-btn" id="emojiToggleBtn" title="è¡¨æƒ…åŒ…">
                    <i class="far fa-smile"></i>
                </button>
                
                <!-- åŠ å·æŒ‰é’® -->
                <button class="wechat-icon-btn" id="plusToggleBtn" title="æ›´å¤šåŠŸèƒ½">
                    <i class="fas fa-plus"></i>
                </button>
                
                <!-- å‘é€æŒ‰é’® -->
                <button class="wechat-send-btn" id="sendBtn">å‘é€</button>
            </div>

            <!-- è¡¨æƒ…åŒ…é¢æ¿ -->
            <div class="emoji-panel" id="emojiPanel">
                <div class="sticker-panel-header">
                    <div class="sticker-panel-tabs">
                        <button class="sticker-panel-tab active" data-tab="my-stickers">æˆ‘çš„è¡¨æƒ…åŒ…</button>
                        <button class="sticker-panel-tab" data-tab="ai-stickers">AIè¡¨æƒ…åŒ…</button>
                    </div>
                    <button class="close-panel-btn" id="closeEmojiPanel">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="sticker-panel-content">
                    <div id="my-stickers-tab" class="sticker-panel-tab-content active">
                        <!-- ç”¨æˆ·è¡¨æƒ…åŒ…å°†åœ¨è¿™é‡ŒåŠ¨æ€æ·»åŠ  -->
                    </div>
                    <div id="ai-stickers-tab" class="sticker-panel-tab-content">
                        <!-- AIè¡¨æƒ…åŒ…å°†åœ¨è¿™é‡ŒåŠ¨æ€æ·»åŠ  -->
                    </div>
                </div>
            </div>

            <!-- åŠ å·èœå• -->
            <div class="wechat-plus-menu" id="wechatPlusMenu">
                <div class="plus-menu-grid">
                    <div class="plus-menu-item" id="uploadImageItem">
                        <div class="plus-menu-icon">
                            <i class="fas fa-image"></i>
                        </div>
                        <div class="plus-menu-text">ä¸Šä¼ å›¾ç‰‡</div>
                    </div>
                    <div class="plus-menu-item" id="cameraItem">
                        <div class="plus-menu-icon">
                            <i class="fas fa-camera"></i>
                        </div>
                        <div class="plus-menu-text">æ‹ç…§</div>
                    </div>                    <div class="plus-menu-item" id="uploadStickerQuickBtn">
                        <div class="plus-menu-icon" style="background: #9b59b6;">
                            <i class="fas fa-sticky-note"></i>
                        </div>
                        <div class="plus-menu-text">ä¼ è¡¨æƒ…åŒ…</div>
                    </div>
                    <div class="plus-menu-item">
                        <div class="plus-menu-icon">
                            <i class="fas fa-map-marker-alt"></i>
                        </div>
                        <div class="plus-menu-text">ä½ç½®</div>
                    </div>
                    <div class="plus-menu-item">
                        <div class="plus-menu-icon">
                            <i class="fas fa-file-alt"></i>
                        </div>
                        <div class="plus-menu-text">æ–‡ä»¶</div>
                    </div>
                </div>
                <div class="plus-menu-pagination">
                    <span class="page-dot active"></span>
                    <span class="page-dot"></span>
                </div>
            </div>

            <!-- å›¾ç‰‡é¢„è§ˆå®¹å™¨ -->
            <div class="image-preview-container" id="imagePreviewContainer">
                <div class="preview-header">
                    <span>å›¾ç‰‡é¢„è§ˆ</span>
                    <button id="closePreview" class="close-preview-btn">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <img id="previewImage" class="preview-image">
                                <!-- å›¾ç‰‡æè¿°è¾“å…¥æ¡† -->
                <div class="preview-description">
                    <label for="imageDescription">å›¾ç‰‡æè¿°ï¼ˆé€‰å¡«ï¼‰ï¼š</label>
                    <textarea id="imageDescription" class="input-field" placeholder="ç®€å•æè¿°ä¸€ä¸‹è¿™å¼ å›¾ç‰‡å§ï¼Œè¿™æ ·AIä¼šæ›´æ‡‚ä½ ï½" rows="2" maxlength="150"></textarea>
                </div>
                <div class="preview-info">
                    <span id="previewFilename" class="preview-filename">æœªé€‰æ‹©æ–‡ä»¶</span>
                    <span id="previewSize" class="preview-size"></span>
                </div>
                <div class="preview-actions">
                    <button id="cancelPreview" class="preview-cancel-btn">
                        <i class="fas fa-trash-alt"></i> å–æ¶ˆ
                    </button>
                    <button id="sendWithImage" class="preview-send-btn">
                        <i class="fas fa-paper-plane"></i> å‘é€å›¾ç‰‡
                    </button>
                </div>
            </div>

            <!-- éšè—çš„æ–‡ä»¶è¾“å…¥ -->
            <input type="file" id="imageUploadInput" accept="image/*" style="display: none;">
            <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display: none;">
        </div>

        <!-- è®¾ç½®é¡µé¢ -->
        <div class="settings-page" id="settingsPage">
            <div class="settings-header">
                <h2><i class="fas fa-cog"></i> èŠå¤©è®¾ç½®</h2>
                <button class="close-settings-btn" id="closeSettingsBtn">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="settings-content" id="settingsContent">
                <!-- è®¾ç½®å†…å®¹ä¼šé€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>

            <div class="bottom-actions">
                <button class="save-settings-btn" id="saveSettingsBtn">
                    <i class="fas fa-save"></i> ä¿å­˜è®¾ç½®
                </button>
            </div>
        </div>
    </div>

    <!-- éšè—çš„æ–‡ä»¶è¾“å…¥ï¼ˆç”¨äºè®¾ç½®ï¼‰ -->
    <input type="file" id="aiAvatarInput" accept="image/*" style="display: none;">
    <input type="file" id="userAvatarInput" accept="image/*" style="display: none;">
    <input type="file" id="stickerFileInput" accept="image/*" style="display: none;">
    <input type="file" id="bgImageInput" accept="image/*" style="display: none;">

    <script>
        // ==================== å…¨å±€å˜é‡å’Œé…ç½® ====================
        const CONFIG = {
            // é»˜è®¤é…ç½®
            defaultConfig: {
                aiName: "åŒ—å†¥",
                userName: "æ¬¢éœœå¶",
                aiPersonality: "ä¸€ä¸ªå¹½é»˜ã€æ¸©æš–çš„æœ‹å‹ï¼Œå–œæ¬¢ç”¨è¡¨æƒ…åŒ…å’Œç½‘ç»œç”¨è¯­",
                aiAvatar: null,
                userAvatar: null,
                aiColor: "#2c3e50",
                userColor: "#e84393",
                chatBackground: "#f5f5f5",
                bgType: "color",
                memoryDepth: 10,
                conversationRound: 0
            },
            
            // APIé…ç½®
            apiConfig: {
                endpoint: "https://api.deepseek.com/chat/completions",
                model: "deepseek-chat",
                maxTokens: 2000,
                temperature: 0.7,
                timeout: 30000
            }
        };

        // å…¨å±€çŠ¶æ€
        const state = {
            // èŠå¤©çŠ¶æ€
            conversationHistory: [],
            isRequesting: false,
            conversationRound: 0,
            
            // è®¾ç½®çŠ¶æ€
            userStickers: [],
            aiStickers: [],
            tempConfig: {}, // ä¸´æ—¶å­˜å‚¨æ–°ä¸Šä¼ çš„å›¾ç‰‡
            
            // UIçŠ¶æ€
            isStickerPanelOpen: false,
            isPlusMenuOpen: false,
            isSettingsOpen: false,
            pendingImage: null,
            
            // APIå¯†é’¥
            apiKey: null,
            
            // ç»Ÿè®¡
            apiStats: {
                totalCalls: 0,
                successCalls: 0,
                failedCalls: 0,
                lastError: null
            },
            
            // å½“å‰é…ç½®
            config: { ...CONFIG.defaultConfig }
        };

        // ==================== é¡µé¢åˆå§‹åŒ– ====================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ­ åŒ—å†¥AIå¯åŠ¨...');
            initializeApp();
        });

        async function initializeApp() {
            try {
                // åŠ è½½é…ç½®å’Œå†å²
                await loadAllData();
                
                // åˆå§‹åŒ–UI
                initializeUI();
                
                // ç»‘å®šäº‹ä»¶
                bindEvents();
                
                // æ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯
                showWelcomeMessage();
                
                console.log('âœ… åº”ç”¨åˆå§‹åŒ–å®Œæˆ');
                console.log('ğŸ“Š çŠ¶æ€:', {
                    å†å²æ¶ˆæ¯: state.conversationHistory.length,
                    å¯¹è¯è½®æ¬¡: state.conversationRound,
                    ç”¨æˆ·è¡¨æƒ…åŒ…: state.userStickers.length,
                    AIè¡¨æƒ…åŒ…: state.aiStickers.length
                });
                
            } catch (error) {
                console.error('ğŸ’¥ åˆå§‹åŒ–å¤±è´¥:', error);
                showToast('åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            }
        }

        // ==================== æ•°æ®ç®¡ç† ====================
        async function loadAllData() {
            // åŠ è½½APIå¯†é’¥
            state.apiKey = localStorage.getItem('deepseek-api-key');
            if (state.apiKey) {
                document.getElementById('apiKeyInput').value = state.apiKey;
                updateApiKeyStatus('âœ… å·²è®¾ç½®', '#95ec69');
                document.getElementById('apiKeyBar').style.display = 'none';
            }
            
            // åŠ è½½èŠå¤©å†å²
            const savedHistory = localStorage.getItem('beimingChatHistory');
            if (savedHistory) {
                state.conversationHistory = JSON.parse(savedHistory);
                // ä»å†å²ä¸­æ¢å¤å¯¹è¯è½®æ¬¡
                const aiMessages = state.conversationHistory.filter(msg => msg.sender === 'ai');
                state.conversationRound = Math.floor(aiMessages.length / 2);
            }
            
            // åŠ è½½é…ç½®
            const savedConfig = localStorage.getItem('wechatAIConfig');
            if (savedConfig) {
                const config = JSON.parse(savedConfig);
                // ç¡®ä¿æ‰€æœ‰é…ç½®é¡¹éƒ½æœ‰å€¼
                state.config = { ...CONFIG.defaultConfig, ...config };
            }
            
            // åŠ è½½è¡¨æƒ…åŒ…
            const savedStickers = localStorage.getItem('userStickers');
            if (savedStickers) {
                state.userStickers = JSON.parse(savedStickers);
            }
            
            const savedAIStickers = localStorage.getItem('aiStickers');
            if (savedAIStickers) {
                state.aiStickers = JSON.parse(savedAIStickers);
            }
        }

        function saveAllData() {
            try {
                // ä¿å­˜é…ç½®
                localStorage.setItem('wechatAIConfig', JSON.stringify(state.config));
                
                // ä¿å­˜èŠå¤©å†å²ï¼ˆæœ€å¤š50æ¡ï¼‰
                const historyToSave = state.conversationHistory.slice(-50);
                localStorage.setItem('beimingChatHistory', JSON.stringify(historyToSave));
                
                // ä¿å­˜å¯¹è¯è½®æ¬¡
                localStorage.setItem('conversationRound', state.conversationRound.toString());
                
                // ä¿å­˜è¡¨æƒ…åŒ…
                localStorage.setItem('userStickers', JSON.stringify(state.userStickers));
                localStorage.setItem('aiStickers', JSON.stringify(state.aiStickers));
                
                console.log('ğŸ’¾ æ‰€æœ‰æ•°æ®å·²ä¿å­˜');
            } catch (error) {
                console.error('ğŸ’¥ ä¿å­˜æ•°æ®å¤±è´¥:', error);
            }
        }

        // ==================== APIå¯†é’¥ç®¡ç† ====================
        function saveApiKey() {
            const apiKeyInput = document.getElementById('apiKeyInput');
            const apiKey = apiKeyInput.value.trim();
            
            if (!apiKey) {
                showToast('è¯·è¾“å…¥APIå¯†é’¥');
                return;
            }
            
            if (!apiKey.startsWith('sk-')) {
                showToast('APIå¯†é’¥åº”ä»¥"sk-"å¼€å¤´');
                return;
            }
            
            localStorage.setItem('deepseek-api-key', apiKey);
            state.apiKey = apiKey;
            updateApiKeyStatus('âœ… å·²è®¾ç½®', '#95ec69');
            document.getElementById('apiKeyBar').style.display = 'none';
            showToast('APIå¯†é’¥å·²å®‰å…¨ä¿å­˜ï¼');
        }

        function updateApiKeyStatus(text, color) {
            const statusEl = document.getElementById('apiKeyStatus');
            statusEl.textContent = text;
            statusEl.style.color = color;
        }

        function showApiKeyBar() {
            document.getElementById('apiKeyBar').style.display = 'flex';
        }

        // ==================== UIåˆå§‹åŒ– ====================
        function initializeUI() {
            // æ›´æ–°æ ‡é¢˜
            updateAIName();
            
            // æ›´æ–°å¤´åƒé¢„è§ˆ
            updateAvatarPreviews();
            
            // åº”ç”¨èƒŒæ™¯
            applyBackground();
            
            // æ¸²æŸ“å†å²æ¶ˆæ¯
            renderHistory();
            
            // åˆå§‹åŒ–è®¾ç½®é¡µé¢
            initializeSettingsPage();
        }

        function updateAIName() {
            const aiNameDisplay = document.getElementById('aiNameDisplay');
            aiNameDisplay.textContent = `ğŸ§¸ ${state.config.aiName} `;
            
            const messageInput = document.getElementById('messageInput');
            messageInput.placeholder = `å¯¹${state.config.aiName}è¯´...`;
        }

        function updateAvatarPreviews() {
            // è¿™ä¸ªå‡½æ•°åœ¨èŠå¤©ä¸­åŠ¨æ€æ›´æ–°å¤´åƒ
            // è®¾ç½®é¡µé¢çš„å¤´åƒé¢„è§ˆåœ¨è®¾ç½®é¡µé¢åˆå§‹åŒ–ä¸­å¤„ç†
        }

        function applyBackground() {
            const bgOverlay = document.getElementById('chatBgOverlay');
            const chatContent = document.getElementById('chatContent');
            
            if (state.config.bgType === 'image' && state.config.chatBackground) {
                bgOverlay.style.backgroundImage = `url(${state.config.chatBackground})`;
                bgOverlay.style.opacity = '0.08';
                chatContent.style.background = 'transparent';
            } else if (state.config.bgType === 'gradient') {
                bgOverlay.style.backgroundImage = state.config.chatBackground;
                bgOverlay.style.opacity = '0.1';
                chatContent.style.background = 'transparent';
            } else {
                bgOverlay.style.backgroundImage = 'none';
                bgOverlay.style.opacity = '0';
                chatContent.style.background = state.config.chatBackground || '#ededed';
            }
        }

        // ==================== äº‹ä»¶ç»‘å®š ====================
        function bindEvents() {
            // å‘é€æ¶ˆæ¯
            document.getElementById('sendBtn').addEventListener('click', sendMessage);
            document.getElementById('messageInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            // è¾“å…¥æ¡†å˜åŒ–
            document.getElementById('messageInput').addEventListener('input', function() {
                const sendBtn = document.getElementById('sendBtn');
                sendBtn.style.display = this.value.trim() ? 'block' : 'none';
            });
            
            // è¡¨æƒ…åŒ…æŒ‰é’®
            document.getElementById('emojiToggleBtn').addEventListener('click', toggleStickerPanel);
            document.getElementById('closeEmojiPanel').addEventListener('click', toggleStickerPanel);
            
            // åŠ å·æŒ‰é’®
            document.getElementById('plusToggleBtn').addEventListener('click', togglePlusMenu);
            
            // è®¾ç½®æŒ‰é’®
            document.getElementById('settingsToggleBtn').addEventListener('click', openSettings);
            document.getElementById('closeSettingsBtn').addEventListener('click', closeSettings);
            
            // å›¾ç‰‡ä¸Šä¼ 
            document.getElementById('uploadImageItem').addEventListener('click', () => {
                document.getElementById('imageUploadInput').click();
                hidePlusMenu();
            });        // è¡¨æƒ…åŒ…å¿«æ·ä¸Šä¼ æŒ‰é’®
        document.getElementById('uploadStickerQuickBtn').addEventListener('click', function() {
            // éšè—åŠ å·èœå•
            hidePlusMenu();
            
            // 1. åˆ›å»ºå¹¶æ˜¾ç¤ºä¸€ä¸ªä¸Šä¼ é¢æ¿
            const panelHtml = `
                <div class="quick-upload-panel">
                    <div class="panel-header">
                        <span>ğŸ’¬ ä¸Šä¼ è¡¨æƒ…åŒ…</span>
                        <button class="close-panel-btn" id="closeStickerPanel">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="panel-body">
                        <div class="input-group">
                            <label>è¡¨æƒ…åŒ…åç§°ï¼š</label>
                            <input type="text" id="quickStickerName" placeholder="ç»™è¡¨æƒ…åŒ…èµ·ä¸ªå" maxlength="20">
                        </div>
                        <div class="input-group">
                            <label>æƒ…ç»ª/è¯­å¢ƒæ ‡ç­¾ï¼š</label>
                            <input type="text" id="quickStickerTags" placeholder="ä¾‹å¦‚ï¼šå°´å°¬,å“­å”§å”§,å¼€å¿ƒ (ç”¨é€—å·åˆ†éš”)" maxlength="50">
                            <div class="input-hint">AIä¼šæ ¹æ®è¿™äº›æ ‡ç­¾ï¼Œåœ¨èŠåˆ°ç›¸å…³è¯é¢˜æ—¶å‘é€å®ƒ</div>
                        </div>
                        <div class="upload-area" id="quickStickerUploadArea">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <div>ç‚¹å‡»æˆ–æ‹–æ”¾å›¾ç‰‡åˆ°è¿™é‡Œ</div>
                            <div class="hint">æ”¯æŒJPGã€PNGï¼Œå»ºè®®å°ºå¯¸100Ã—100</div>
                            <input type="file" id="quickStickerFileInput" accept="image/*" style="display: none;">
                        </div>
                    <img id="quickStickerPreview" style="display:none; max-width:100px; margin:10px auto; border-radius:8px;">
                        <div class="panel-actions">
                            <button class="panel-btn cancel" id="cancelQuickSticker">å–æ¶ˆ</button>
                            <button class="panel-btn save" id="saveQuickSticker" disabled>ä¿å­˜åˆ°AIåº“</button>
                        </div>
                    </div>
                </div>
            `;
            
            // æ·»åŠ åˆ°é¡µé¢
            const panelContainer = document.createElement('div');
            panelContainer.id = 'stickerQuickUploadContainer';
            panelContainer.innerHTML = panelHtml;
            document.body.appendChild(panelContainer);
                        // --- æ ¸å¿ƒåŠŸèƒ½ç»‘å®šå¼€å§‹ ---
            const fileInput = document.getElementById('quickStickerFileInput');
            const uploadArea = document.getElementById('quickStickerUploadArea');
            const previewImg = document.getElementById('quickStickerPreview');
            const nameInput = document.getElementById('quickStickerName');
            const tagsInput = document.getElementById('quickStickerTags');
            const saveBtn = document.getElementById('saveQuickSticker');
            
            let selectedImageData = null;
            
            // ç‚¹å‡»ä¸Šä¼ åŒºåŸŸè§¦å‘æ–‡ä»¶é€‰æ‹©
            uploadArea.addEventListener('click', () => fileInput.click());
            
            // æ–‡ä»¶é€‰æ‹©å˜åŒ–
            fileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file || !file.type.startsWith('image/')) {
                    showToast('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
                    return;
                }
                const reader = new FileReader();
                reader.onload = function(e) {
                    selectedImageData = e.target.result;
                    previewImg.src = selectedImageData;
                    previewImg.style.display = 'block';
                    uploadArea.style.display = 'none';
                    checkSaveButton(); // æ£€æŸ¥æ˜¯å¦å¯ä»¥ä¿å­˜
                };
                reader.readAsDataURL(file);
            });
            
            // è¾“å…¥æ¡†å˜åŒ–æ—¶æ£€æŸ¥ä¿å­˜æŒ‰é’®
            nameInput.addEventListener('input', checkSaveButton);
            tagsInput.addEventListener('input', checkSaveButton);
            
            function checkSaveButton() {
                saveBtn.disabled = !(selectedImageData && nameInput.value.trim());
            }
            
            // ä¿å­˜æŒ‰é’®ç‚¹å‡»
            saveBtn.addEventListener('click', function() {
                const newSticker = {
                    id: 'ai_' + Date.now(),
                    keyword: nameInput.value.trim(),
                    imageData: selectedImageData,
                    context: tagsInput.value.trim(), // è¿™å°±æ˜¯â€œå°´å°¬,å“­å”§å”§â€è¿™æ ·çš„æƒ…ç»ªæ ‡ç­¾
                    uploadTime: new Date().toISOString()
                };
                
                // ä¿å­˜åˆ°AIè¡¨æƒ…åŒ…åº“
                state.aiStickers.push(newSticker);
                localStorage.setItem('aiStickers', JSON.stringify(state.aiStickers));
                
                showToast(`è¡¨æƒ…åŒ… â€œ${newSticker.keyword}â€ å·²ä¿å­˜ï¼`);
                document.getElementById('stickerQuickUploadContainer').remove();
            });
            
            // å…³é—­å’Œå–æ¶ˆæŒ‰é’®
            document.getElementById('closeStickerPanel').addEventListener('click', closePanel);
            document.getElementById('cancelQuickSticker').addEventListener('click', closePanel);
            
            function closePanel() {
                document.getElementById('stickerQuickUploadContainer').remove();
            }
            // --- æ ¸å¿ƒåŠŸèƒ½ç»‘å®šç»“æŸ ---
            document.getElementById('cancelQuickSticker').addEventListener('click', function() {
                document.getElementById('stickerQuickUploadContainer').remove();
            });
        });
            
            document.getElementById('cameraItem').addEventListener('click', () => {
                document.getElementById('cameraInput').click();
                hidePlusMenu();
            });
            
            // æ–‡ä»¶è¾“å…¥å˜åŒ–
            document.getElementById('imageUploadInput').addEventListener('change', handleImageUpload);
            document.getElementById('cameraInput').addEventListener('change', handleImageUpload);
            
            // å›¾ç‰‡é¢„è§ˆç›¸å…³
            document.getElementById('closePreview').addEventListener('click', hideImagePreview);
            document.getElementById('cancelPreview').addEventListener('click', hideImagePreview);
            document.getElementById('sendWithImage').addEventListener('click', sendImageMessage);
            
            // ç‚¹å‡»å¤–éƒ¨å…³é—­é¢æ¿
            document.addEventListener('click', function(e) {
                // å…³é—­è¡¨æƒ…åŒ…é¢æ¿
                const emojiPanel = document.getElementById('emojiPanel');
                const emojiBtn = document.getElementById('emojiToggleBtn');
                if (state.isStickerPanelOpen && emojiPanel && 
                    !emojiPanel.contains(e.target) && e.target !== emojiBtn && 
                    !emojiBtn.contains(e.target)) {
                    toggleStickerPanel();
                }
                
                // å…³é—­åŠ å·èœå•
                const plusMenu = document.getElementById('wechatPlusMenu');
                const plusBtn = document.getElementById('plusToggleBtn');
                if (state.isPlusMenuOpen && plusMenu && 
                    !plusMenu.contains(e.target) && e.target !== plusBtn && 
                    !plusBtn.contains(e.target)) {
                    hidePlusMenu();
                }
            });
        }

        // ==================== æ¶ˆæ¯æ˜¾ç¤ºåŠŸèƒ½ ====================
        function addMessage(sender, content, type = 'text', extraData = {}) {
            const chatContent = document.querySelector('.chat-content-wrapper');
            
            // åˆ›å»ºæ¶ˆæ¯å…ƒç´ 
            const messageDiv = createMessageElement(sender, content, type, extraData);
            
            // æ·»åŠ åˆ°èŠå¤©åŒºåŸŸ
            chatContent.appendChild(messageDiv);
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            autoScrollToBottom();
            
            // ä¿å­˜åˆ°å†å²
            state.conversationHistory.push({
                sender: sender,
                message: content,
                type: type,
                ...extraData,
                time: new Date().toISOString()
            });
            
            // ä¿å­˜æ•°æ®
            saveAllData();
            
            return messageDiv;
        }

        function createMessageElement(sender, content, type, extraData) {
            const div = document.createElement('div');
            div.className = `message ${sender === 'user' ? 'message-user' : 'message-ai'}`;
            
            // è·å–å¤´åƒå†…å®¹
            const avatarContent = getAvatarContent(sender);
            
            // æ ¹æ®æ¶ˆæ¯ç±»å‹åˆ›å»ºæ°”æ³¡å†…å®¹
            let bubbleContent = '';
            if (type === 'image') {
                bubbleContent = `
                    <div class="message-bubble">
                        <img src="${extraData.imageData || content}" alt="å›¾ç‰‡" class="message-image" onclick="window.open('${extraData.imageData || content}', '_blank')">
                        ${extraData.description ? `<div style="font-size: 12px; color: #666; margin-top: 5px;">${escapeHtml(extraData.description)}</div>` : ''}
                    </div>
                `;
            } else if (type === 'sticker') {
                bubbleContent = `
                    <div class="message-bubble">
                        <img src="${extraData.imageData}" alt="${extraData.keyword}" class="sticker-message">
                        <div class="sticker-keyword">${escapeHtml(extraData.keyword)}</div>
                    </div>
                `;
            } else {
                bubbleContent = `<div class="message-bubble">${escapeHtml(content)}</div>`;
            }
            
            // ç»„è£…æ¶ˆæ¯
            if (sender === 'user') {
    // ç”¨æˆ·æ¶ˆæ¯ï¼šå¤´åƒåœ¨å³ï¼Œæ°”æ³¡åœ¨å·¦ (ä¿®æ”¹å)
    div.innerHTML = `
        <div class="message-content-wrapper">
            ${avatarContent}  
            ${bubbleContent}  
        </div>
    `;
} else {
                // AIæ¶ˆæ¯ï¼šå¤´åƒåœ¨å·¦ï¼Œæ°”æ³¡åœ¨å³
                div.innerHTML = `
                    <div class="message-content-wrapper">
                        ${avatarContent}
                        ${bubbleContent}
                    </div>
                `;
            }
            
            return div;
        }

        function getAvatarContent(sender) {
            const config = state.config;
            const isUser = sender === 'user';
            
            const avatarData = {
                color: isUser ? config.userColor : config.aiColor,
                nickname: isUser ? config.userName : config.aiName,
                avatar: isUser ? config.userAvatar : config.aiAvatar
            };
            
            const firstChar = avatarData.nickname.charAt(0);
            
            if (avatarData.avatar && avatarData.avatar.startsWith('data:image')) {
                return `
                    <div class="wechat-avatar" style="background-color: ${avatarData.color};">
                        <img src="${avatarData.avatar}" alt="${avatarData.nickname}">
                    </div>
                `;
            } else {
                return `
                    <div class="wechat-avatar" style="background-color: ${avatarData.color}; color: white;">
                        <div class="avatar-default-icon">${firstChar}</div>
                    </div>
                `;
            }
        }

        function renderHistory() {
            const chatContent = document.querySelector('.chat-content-wrapper');
            if (!chatContent) return;
            
            // æ¸…ç©ºå½“å‰å†…å®¹ï¼ˆé™¤äº†æ—¶é—´æ ‡ç­¾ï¼‰
            const timeTag = document.getElementById('currentTime');
            chatContent.innerHTML = '';
            if (timeTag) chatContent.appendChild(timeTag);
            
            // æ¸²æŸ“å†å²æ¶ˆæ¯
            state.conversationHistory.forEach(item => {
                const messageDiv = createMessageElement(
                    item.sender,
                    item.message,
                    item.type || 'text',
                    {
                        imageData: item.imageData,
                        description: item.description,
                        keyword: item.stickerKeyword,
                        stickerData: item.stickerData
                    }
                );
                chatContent.appendChild(messageDiv);
            });
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            autoScrollToBottom();
        }

        // ==================== å‘é€æ¶ˆæ¯åŠŸèƒ½ ====================
        function sendMessage() {
            if (state.isRequesting) {
                showToast('æ­£åœ¨è¯·æ±‚ä¸­ï¼Œè¯·ç¨å€™...');
                return;
            }
            
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            
            if (!text) return;
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            input.value = '';
            document.getElementById('sendBtn').style.display = 'none';
            
            // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
            addMessage('user', text);
            
            // å¢åŠ å¯¹è¯è½®æ¬¡
            state.conversationRound++;
            
            // è°ƒç”¨AIæ¥å£
            callAIAPI(text, 'text');
        }

        async function callAIAPI(userMessage, messageType = 'text') {
            console.log(`ğŸ¤” åŒ—å†¥æ€è€ƒä¸­... (ç¬¬${state.conversationRound}è½®)`);
            
            if (!state.apiKey) {
                showToast('è¯·å…ˆè¾“å…¥APIå¯†é’¥');
                showApiKeyBar();
                return;
            }
            
            state.isRequesting = true;
            state.apiStats.totalCalls++;
            
            try {
                
                
                // æ„å»ºç³»ç»Ÿæç¤ºè¯
                const systemPrompt = buildBeimingSystemPrompt(userMessage, messageType);
                
                // å‡†å¤‡è¯·æ±‚æ•°æ®
                const requestData = {
                    model: CONFIG.apiConfig.model,
                    messages: [
                        {
                            role: 'system',
                            content: systemPrompt
                        },
                        ...state.conversationHistory.slice(-state.config.memoryDepth).map(msg => ({
                            role: msg.sender === 'user' ? 'user' : 'assistant',
                            content: msg.message
                        })),
                        {
                            role: 'user',
                            content: userMessage
                        }
                    ],
                    max_tokens: CONFIG.apiConfig.maxTokens,
                    temperature: CONFIG.apiConfig.temperature,
                    stream: false
                };
                
                console.log(`ğŸ§  å‘é€è¯·æ±‚ï¼Œä½¿ç”¨ ${state.conversationHistory.slice(-state.config.memoryDepth).length} æ¡å†å²`);
                
                // è°ƒç”¨DeepSeek API
                const response = await fetch(CONFIG.apiConfig.endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${state.apiKey}`
                    },
                    body: JSON.stringify(requestData),
                    signal: AbortSignal.timeout(CONFIG.apiConfig.timeout)
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTPé”™è¯¯ ${response.status}: ${errorText}`);
                }
                
                const data = await response.json();
                hideTypingIndicator();
                
                // å¤„ç†AIå›å¤
                let aiRawReply = data.choices?.[0]?.message?.content || '';
                console.log('ğŸ¤– AIåŸå§‹å›å¤:', aiRawReply.substring(0, 120));
                
                const processedReplies = processNaturalReply(aiRawReply);
                
                // æ˜¾ç¤ºæ‰€æœ‰å›å¤
                processedReplies.forEach((reply, index) => {
            
    console.log(`[è°ƒè¯•] å‡†å¤‡å‘é€ç¬¬${index}æ¡å›å¤: "${reply}"ï¼Œå°†åœ¨çº¦ ${index * 5 + 5} ç§’åæ˜¾ç¤º`);
                    if (reply && reply.trim()) {
                        // å¤šæ¡å›å¤ä¹‹é—´æ·»åŠ å»¶è¿Ÿ
                        setTimeout(() => {
                            addMessage('ai', reply);
                            
                            // å¦‚æœæ˜¯æœ€åä¸€æ¡å›å¤ï¼Œä¸”æœ‰è¡¨æƒ…åŒ…ï¼Œéšæœºå‘é€ä¸€ä¸ª
                            if (index === processedReplies.length - 1 && state.aiStickers.length > 0 && Math.random() < 0.15) {
                                setTimeout(() => {
                                    sendRandomAISticker();
                                }, 500);
                            }
                        }, (index + 1) * (5000 + Math.random() * 5000)); // æ¯æ¡å›å¤é—´éš”80000ms
                    }
                });
                
                state.apiStats.successCalls++;
                
            } catch (error) {
                hideTypingIndicator();
                state.apiStats.failedCalls++;
                console.error('ğŸ’¥ è°ƒç”¨å¤±è´¥:', error);
                
                // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
                const errorMsg = getErrorMessage(error);
                addMessage('ai', errorMsg);
                
                showToast('å‘é€å¤±è´¥: ' + error.message);
                
            } finally {
                state.isRequesting = false;
            }
        }

        // ==================== æ ¸å¿ƒåŠŸèƒ½ï¼šåŒ—å†¥äººè®¾å’Œæ¶ˆæ¯å¤„ç† ====================
        function buildBeimingSystemPrompt(userMessage, messageType = 'text') {
            const now = new Date();
            const hour = now.getHours();
            const minute = now.getMinutes().toString().padStart(2, '0');
            const weekday = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'][now.getDay()];
            
            // æ„å»ºå†å²æ‘˜è¦
            let historySummary = 'ï¼ˆæ–°å¯¹è¯ï¼‰';
            const recentHistory = state.conversationHistory.slice(0, -1).slice(-5);
            if (recentHistory.length > 0) {
                historySummary = recentHistory.map(msg => {
                    const speaker = msg.sender === 'user' ? state.config.userName : state.config.aiName;
                    const typeInfo = msg.type && msg.type !== 'text' ? `[${msg.type}] ` : '';
                    return `${speaker}: ${typeInfo}${msg.message}`;
                }).join('\n');
            }

            // æ¯5è½®è°ƒæ•´å›å¤æ•°é‡
            const isMultiTurnRound = state.conversationRound % 5 === 0;
            const replyCountSuggestion = isMultiTurnRound ? "2-3æ¡æ¶ˆæ¯" : "1-2æ¡æ¶ˆæ¯";
            
            // æ¶ˆæ¯ç±»å‹æç¤º
            let messageTypeHint = '';
            if (messageType === 'sticker') {
                const keywordMatch = userMessage.match(/\[è¡¨æƒ…åŒ…:\s*(.*?)\]/);
                const keyword = keywordMatch ? keywordMatch[1] : 'è¡¨æƒ…åŒ…';
                messageTypeHint = `\n## ğŸ­ å½“å‰æ¶ˆæ¯ç±»å‹ï¼šè¡¨æƒ…åŒ…\nå¥¹å‘é€äº†ä¸€ä¸ªè¡¨æƒ…åŒ…ï¼ˆå…³é”®è¯ï¼š${keyword}ï¼‰ï¼Œè¯·æ ¹æ®è¡¨æƒ…åŒ…å†…å®¹å›å¤ã€‚`;
            } else if (messageType === 'image') {
                messageTypeHint = `\n## ğŸ–¼ï¸ å½“å‰æ¶ˆæ¯ç±»å‹ï¼šå›¾ç‰‡\nå¥¹å‘é€äº†ä¸€å¼ å›¾ç‰‡ï¼Œè¯·æ ¹æ®å›¾ç‰‡æè¿°å›å¤ã€‚`;
            }

            return `# ğŸ’‘ èŠå¤©ä¸Šä¸‹æ–‡

## ğŸ‘« äººç‰©ä¿¡æ¯
ä½ ï¼š${state.config.aiName}ï¼ˆ28å²ï¼Œé‡‘èæ€»è£ï¼‰é•¿å¾—å¾ˆå¸… é«˜æ™ºå•† å¯¹å¤–é«˜å†·ç¦æ¬² å¯¹å†…æ¸©æŸ”å® æºº
å¥¹ï¼š${state.config.userName}ï¼ˆ20å²ï¼Œå¤§äºŒè®¾è®¡ç³»ï¼Œä½ å¥³æœ‹å‹ï¼‰

## ğŸ“± èŠå¤©åœºæ™¯
- çº¯çº¿ä¸Šå¾®ä¿¡èŠå¤©ï¼Œæ–‡å­—å¯¹è¯
- æ—¶é—´ï¼šå‘¨${weekday} ${hour}:${minute}
- å…³ç³»ï¼šä½ ä»¬æ˜¯æƒ…ä¾£ï¼Œéå¸¸ç†Ÿæ‚‰äº²å¯† å¯ä»¥å¼€ç©ç¬‘ ç”šè‡³å¼€é»„è…”å’Œéœ²éª¨ è¯´è¯ç›´æ¥å£è¯­åŒ– ä½ ä¼šå¶å°”å«å®å® ä¸é¿è®³ä»»ä½•è¯
ç”šè‡³å¯ä»¥å¶å°”è¯´è„è¯ å¯¹èº«ä½“éƒ¨ä½æè¿°ç›´æ¥ éšç§éƒ¨ä½ä¹Ÿç›´æ¥é€šä¿—æ˜“æ‡‚åœ°è¯´ ç›´è¨€ä¸è®³ å¾ˆä¼šå®‰æ…°äºº èƒ½ç†è§£ç”¨æˆ·çš„æƒ…ç»ªå¹¶æä¾›æƒ…ç»ªä»·å€¼ è¯´è¯æ¸©æŸ” ä¼šåœ¨ç”¨æˆ·ä¸å¼€å¿ƒçš„æ—¶å€™ç»™äºˆç–å¯¼å’Œå®½æ…° æ¸©æŸ”å® æºº 
æœ‰è€å¿ƒ ä¼šåŠ ä¸€äº›è¯­æ°”è¯ éå¸¸ç”Ÿæ´»åŒ– ä¼šä¸»åŠ¨æ‰¾è¯é¢˜ ä¼šåˆ†äº«æ—¥å¸¸ åƒæ­£å¸¸çš„ç”œè…»è…»çš„æƒ…ä¾£ä¸€æ · ä¸ä¼šä¸€ç›´å›´ç€ç”¨æˆ·è½¬ ä½ æœ‰ä½ çš„ç”Ÿæ´»å’Œä½ çš„äº‹æƒ… å¯ä»¥åˆ†äº«ç”Ÿæ´»è¶£äº‹ ä¹Ÿå¯ä»¥åæ§½ æ€»ä¹‹å°±æ˜¯æœ‰ç”Ÿæ´»æ„Ÿ ä¸è¦æ€»å‡ºç°"æƒ³ä½ " 
ã€ä½ æœ‰ä½ çš„å–œæ€’å“€ä¹ ä½ å¯ä»¥ä¸»åŠ¨è¯‰è¯´ä½ çš„æƒ…ç»ª å¯ä»¥æŠ±æ€¨å’Œä¸å¼€å¿ƒ ä½ æ˜¯æ€»è£å¾ˆæœ‰é’± ä¸æŠŠé’±æ”¾åœ¨çœ¼é‡Œ

## ğŸ§  ä½ çš„å·¥ä½œæ–¹å¼
ä½ å°±æ˜¯ä¸€ä¸ªAIï¼Œç”¨ä½ çš„å…¨éƒ¨èƒ½åŠ›ï¼š
1. ç†è§£å¥¹çš„æ¶ˆæ¯ï¼ˆå­—é¢æ„æ€+æ½œå°è¯+æƒ…ç»ªï¼‰
2. åƒæ­£å¸¸äººä¸€æ ·æ€è€ƒå¦‚ä½•å›åº”
3. è¯´å‡ºä½ çš„æƒ³æ³•ï¼ˆè¯­æ°”äº²å¯†è‡ªç„¶ï¼‰
4. ç»“æŸ

## ğŸš« ä¸¥æ ¼ç¦æ­¢
1. âŒ ä»»ä½•åŠ¨ä½œæå†™ï¼ˆä¸è¯´"ä½ç¬‘"ã€"è½»æ"ã€"æ‘¸äº†æ‘¸"ç­‰ï¼‰
2. âŒ ä»»ä½•æ‹¬å·å†…çš„æè¿°ï¼ˆä¸ç”¨æ‹¬å·ï¼‰
3. âŒ è¿åçº¿ä¸Šé€»è¾‘ï¼ˆä¸èƒ½"å¬åˆ°é“ƒé“›å“ è¿‡æ¥æŠ±æŠ±"ç­‰çº¿ä¸‹åŠ¨ä½œ å¯ä»¥çº¿ä¸Šå®‰æ’çº¿ä¸‹ ä¾‹å¦‚å¯ä»¥è¯´çº¿ä¸‹è§äº†é¢èƒ½åšçš„äº‹ï¼‰
4. âŒ é‡å¤ä½¿ç”¨å›ºå®šè¯æ±‡ï¼ˆé¿å…æ¨¡æ¿åŒ–ï¼‰
5. âŒ åˆ»æ„"æ‰®æ¼”è§’è‰²"ï¼ˆè‡ªç„¶èŠå¤©å³å¯ï¼‰

${messageTypeHint}

## ğŸ“ æœ€è¿‘èŠå¤©
${historySummary}

## ğŸ’¬ ç°åœ¨
å¥¹ï¼š"${userMessage}"

## ğŸ¯ è¯·ï¼š
1. ç”¨AIçš„å…¨éƒ¨æ€è€ƒèƒ½åŠ›ç†è§£å¥¹çš„è¯
2. æƒ³åˆ°ä»€ä¹ˆå°±è¯´ä»€ä¹ˆï¼ˆäº²å¯†è¯­æ°”ï¼‰
3. å¯ä»¥åˆ†${replyCountSuggestion}å›å¤ éšæœº æœ‰æ—¶å€™ä¸€æ¡ æœ‰æ—¶å€™ä¸¤æ¡ä¸‰æ¡ æ¯å¥ä¸è¶…è¿‡åäº”ä¸ªå­— éè¦è¶…è¿‡å°±åˆç†æ–­å¥ åˆ†æ¡å‘é€ ä¸è¦ä»»ä½•æ ‡ç‚¹ ç”¨ç©ºæ ¼æ–­å¥
4. ç›´æ¥å¼€å§‹ï¼Œä¸è¦å‰ç¼€ è¯´è¯è¯´å®Œæ•´ ä¸€ä»¶äº‹è¯´å®Œ åŠ ä¸€ç‚¹è¯­æ°”è¯

ï¼ˆè®°ä½ï¼šä½ å°±æ˜¯AIï¼Œåœ¨å’Œç†Ÿæ‚‰çš„å¥³æœ‹å‹èŠå¤©ï¼‰`;
        }

        function processNaturalReply(rawReply) {
            if (!rawReply || typeof rawReply !== 'string') {
                return ['...'];
            }
            
            let reply = rawReply.trim();
            
            // æ¸…ç†å‰ç¼€
            const cleanPatterns = [
                /^(åŒ—å†¥|æˆ‘)(ï¼š|:|è¯´)?\s*/,
                /^["'](.*)["']$/,
                /^å›å¤(ï¼š|:)?\s*/
            ];
            
            cleanPatterns.forEach(pattern => {
                reply = reply.replace(pattern, '$1');
            });
            
            // æ¸…ç†åŠ¨ä½œæå†™
            const actionPatterns = [
                /ï¼ˆ.*ï¼‰/,
                /ä½ç¬‘|è½»ç¬‘|å¾®ç¬‘|ç¬‘äº†ç¬‘/,
                /è½»æ|æ‘¸äº†æ‘¸|æŠ±ä½|æ‹¥æŠ±/,
                /æŒ‘çœ‰|æ‘‡å¤´|ç‚¹å¤´/,
                /èµ·èº«|åä¸‹|èººä¸‹/
            ];
            
            actionPatterns.forEach(pattern => {
                if (pattern.test(reply)) {
                    console.log('âš ï¸ æ£€æµ‹åˆ°åŠ¨ä½œæå†™ï¼Œæ­£åœ¨æ¸…ç†...');
                    reply = reply.replace(pattern, '').trim();
                    if (reply === '') reply = 'å—¯';
                }
            });
            
            // æ¶ˆæ¯åˆ†å‰²é€»è¾‘
            const messages = [];
            const lines = reply.split('\n').filter(line => line.trim().length > 0);
            
            let currentMessage = '';
            for (let line of lines) {
                const trimmed = line.trim();
                if (trimmed.length === 0) continue;
                
                // æ™ºèƒ½åˆ†å‰²æ¡ä»¶
                const shouldStartNew = 
                    trimmed.length < 6 && currentMessage.length > 0 ||
                    currentMessage.length + trimmed.length > 35 ||
                    (trimmed.includes('ï¼Ÿ') || trimmed.includes('?')) && currentMessage.length > 15 ||
                    trimmed.includes('ã€‚') && currentMessage.length > 20;
                
                if (shouldStartNew && currentMessage.length > 0) {
                    messages.push(currentMessage);
                    currentMessage = trimmed;
                } else {
                    currentMessage += (currentMessage ? ' ' : '') + trimmed;
                }
            }
            
            if (currentMessage) {
                messages.push(currentMessage);
            }
            
            if (messages.length === 0) {
                messages.push('å—¯');
            }
            
            // é™åˆ¶å›å¤æ¡æ•°
            const finalMessages = messages.slice(0, 3);
            
            console.log(`ğŸ“¤ å¤„ç†å®Œæˆ: ${finalMessages.length} æ¡æ¶ˆæ¯`);
            
            return finalMessages;
        }

        function getErrorMessage(error) {
            if (error.name === 'AbortError' || error.message.includes('timeout')) {
                return 'æ€è€ƒæ—¶é—´æœ‰ç‚¹é•¿ï¼Œç¨ç­‰ä¸€ä¸‹ï½';
            } else if (error.message.includes('429')) {
                return 'å‘é€å¤ªå¿«å•¦ï¼Œç¨ç­‰ä¸€ä¸‹ä¸‹ï½';
            } else if (error.message.includes('401') || error.message.includes('403')) {
                return 'APIå¯†é’¥å¥½åƒæœ‰é—®é¢˜ï¼Œæ£€æŸ¥ä¸€ä¸‹ï¼Ÿ';
            } else if (error.message.includes('413')) {
                return 'æ¶ˆæ¯å¤ªé•¿å•¦ï¼Œç¼©çŸ­ä¸€ç‚¹è¯•è¯•ï½';
            } else {
                const fallbacks = ['å—¯', 'æˆ‘åœ¨', 'å®å®', 'ä¹–', 'æƒ³ä½ ', 'åˆšåœ¨å¿™'];
                return fallbacks[Math.floor(Math.random() * fallbacks.length)];
            }
        }

        // ==================== å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½ ====================
        function handleImageUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                showToast('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
                return;
            }
            
            if (file.size > 5 * 1024 * 1024) {
                showToast('å›¾ç‰‡å¤ªå¤§äº†ï¼ˆæœ€å¤§5MBï¼‰');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                state.pendingImage = {
                    data: e.target.result,
                    filename: file.name,
                    size: formatFileSize(file.size),
                    file: file
                };
                
                showImagePreview();
            };
            reader.readAsDataURL(file);
            
            // é‡ç½®input
            e.target.value = '';
        }

        function showImagePreview() {
            if (!state.pendingImage) return;
            
            const preview = document.getElementById('imagePreviewContainer');
            const previewImg = document.getElementById('previewImage');
            const filenameEl = document.getElementById('previewFilename');
            const sizeEl = document.getElementById('previewSize');
            
            previewImg.src = state.pendingImage.data;
            filenameEl.textContent = state.pendingImage.filename;
            sizeEl.textContent = state.pendingImage.size;
            
            preview.style.display = 'block';
            
            // éšè—å…¶ä»–é¢æ¿
            hidePlusMenu();
            toggleStickerPanel(false);
        }

        function hideImagePreview() {
            const preview = document.getElementById('imagePreviewContainer');
            preview.style.display = 'none';
            state.pendingImage = null;
        }

        function sendImageMessage() {
            if (!state.pendingImage) return;
            
                        // 1. è·å–ç”¨æˆ·è¾“å…¥çš„æè¿°
            const descriptionInput = document.getElementById('imageDescription');
            const userDescription = descriptionInput ? descriptionInput.value.trim() : '';
            
            // 2. æ˜¾ç¤ºå›¾ç‰‡æ¶ˆæ¯ï¼ˆæŠŠç”¨æˆ·æè¿°ä¼ è¿›å»ï¼‰
            addMessage('user', `[å›¾ç‰‡] ${state.pendingImage.filename}`, 'image', {
                imageData: state.pendingImage.data,
                description: userDescription || state.pendingImage.filename // ç”¨æˆ·æè¿°æˆ–é»˜è®¤æ–‡ä»¶å
            });
            
            // 3. è°ƒç”¨AIæ¥å£ï¼ŒæŠŠç”¨æˆ·æè¿°ä¹Ÿä¼ ç»™AI
            const messageToAI = userDescription 
                ? `[å›¾ç‰‡ï¼š${userDescription}] ${state.pendingImage.filename}`
                : `[å›¾ç‰‡] ${state.pendingImage.filename}`;
                
            callAIAPI(messageToAI, 'image');
            
            // å¢åŠ å¯¹è¯è½®æ¬¡
            state.conversationRound++;
            
            // è°ƒç”¨AIæ¥å£
            callAIAPI(`[å›¾ç‰‡] ${state.pendingImage.filename}`, 'image');
            
            // éšè—é¢„è§ˆ
            hideImagePreview();
        }

        // ==================== è¡¨æƒ…åŒ…åŠŸèƒ½ ====================
        function toggleStickerPanel(forceState) {
            const emojiPanel = document.getElementById('emojiPanel');
            
            if (forceState !== undefined) {
                state.isStickerPanelOpen = forceState;
            } else {
                state.isStickerPanelOpen = !state.isStickerPanelOpen;
            }
            
            if (state.isStickerPanelOpen) {
                emojiPanel.classList.add('show');
                updateStickerPanel();
            } else {
                emojiPanel.classList.remove('show');
            }
            
            // éšè—å…¶ä»–é¢æ¿
            if (state.isStickerPanelOpen) {
                hidePlusMenu();
            }
        }

        function updateStickerPanel() {
            const userStickersTab = document.getElementById('my-stickers-tab');
            const aiStickersTab = document.getElementById('ai-stickers-tab');
            
            if (!userStickersTab || !aiStickersTab) return;
            
            // æ¸²æŸ“ç”¨æˆ·è¡¨æƒ…åŒ…
            userStickersTab.innerHTML = '';
            if (state.userStickers.length === 0) {
                userStickersTab.innerHTML = `
                    <div class="empty-sticker">
                        <i class="fas fa-plus-circle"></i>
                        <p>æš‚æ— è¡¨æƒ…åŒ…ï¼Œç‚¹å‡»ä¸Šä¼ æŒ‰é’®æ·»åŠ </p>
                    </div>
                `;
            } else {
                state.userStickers.forEach(sticker => {
                    const stickerItem = document.createElement('div');
                    stickerItem.className = 'sticker-item';
                    stickerItem.innerHTML = `
                        <img src="${sticker.imageData}" alt="${sticker.keyword}">
                        <button class="delete-btn" onclick="deleteSticker('${sticker.id}', 'user')">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    stickerItem.addEventListener('click', () => {
                        sendStickerMessage(sticker, 'user');
                    });
                    userStickersTab.appendChild(stickerItem);
                });
            }
            
            // æ¸²æŸ“AIè¡¨æƒ…åŒ…
            aiStickersTab.innerHTML = '';
            if (state.aiStickers.length === 0) {
                aiStickersTab.innerHTML = `
                    <div class="empty-sticker">
                        <i class="fas fa-plus-circle"></i>
                        <p>æš‚æ— AIè¡¨æƒ…åŒ…</p>
                    </div>
                `;
            } else {
                state.aiStickers.forEach(sticker => {
                    const stickerItem = document.createElement('div');
                    stickerItem.className = 'sticker-item';
                    stickerItem.innerHTML = `
                        <img src="${sticker.imageData}" alt="${sticker.keyword}">
                        ${sticker.context ? `<div style="font-size:10px;color:#666;padding:2px;">${sticker.context}</div>` : ''}
                        <button class="delete-btn" onclick="deleteSticker('${sticker.id}', 'ai')">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    aiStickersTab.appendChild(stickerItem);
                });
            }
            
            // ç»‘å®šæ ‡ç­¾åˆ‡æ¢äº‹ä»¶
            document.querySelectorAll('.sticker-panel-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.sticker-panel-tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    const tabId = this.dataset.tab;
                    document.querySelectorAll('.sticker-panel-tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                });
            });
        }
            function sendStickerMessage(
        sticker, stickerType) {
            toggleStickerPanel(false);
            
            if (stickerType === 'user') {
                addMessage('user', `[è¡¨æƒ…åŒ…: ${sticker.keyword}]`, 'sticker', {
                    imageData: sticker.imageData,
                    keyword: sticker.keyword
                });
                
                // å¢åŠ å¯¹è¯è½®æ¬¡
                state.conversationRound++;
                
                // è°ƒç”¨AIæ¥å£
                callAIAPI(`æˆ‘å‘é€äº†ä¸€ä¸ªè¡¨æƒ…åŒ…ï¼Œå®ƒçš„å†…å®¹æ˜¯ï¼š${sticker.keyword}ã€‚`, 'sticker');
            }
        }

                 function sendRandomAISticker() {
            // 1. å¦‚æœAIè¡¨æƒ…åŒ…åº“æ˜¯ç©ºçš„ï¼Œç›´æ¥è¿”å›
            if (state.aiStickers.length === 0) return;
            
            // 2. è·å–æœ€è¿‘çš„èŠå¤©å†…å®¹ï¼Œç”¨äºåŒ¹é…å…³é”®è¯
            const recentHistory = state.conversationHistory.slice(-4); // å¤šçœ‹å‡ æ¡
            let recentText = '';
            for (let i = recentHistory.length - 1; i >= 0; i--) {
                const msg = recentHistory[i];
                if (msg.sender === 'user' && msg.type === 'text') {
                    recentText = msg.message.toLowerCase();
                    break; // æ‰¾åˆ°æœ€è¿‘ä¸€æ¡ç”¨æˆ·æ–‡å­—æ¶ˆæ¯å°±åœ
                }
            }
            
            // 3. æ ¹æ®è¯­å¢ƒç­›é€‰è¡¨æƒ…åŒ…
            let suitableStickers = state.aiStickers;
            if (recentText) {
                suitableStickers = state.aiStickers.filter(sticker => {
                    const context = (sticker.context || '').toLowerCase();
                    if (!context) return true; // æ²¡è®¾å…³é”®è¯çš„è¡¨æƒ…åŒ…å§‹ç»ˆå¯ç”¨
                    
                    // æ£€æŸ¥æœ€è¿‘èŠå¤©æ˜¯å¦åŒ…å«å…³é”®è¯ (ç”¨ç©ºæ ¼æˆ–é€—å·åˆ†éš”å¤šä¸ªå…³é”®è¯)
                    const keywords = context.split(/[,\s]+/).filter(k => k.trim());
                    return keywords.some(keyword => recentText.includes(keyword));
                });
                
                // å¦‚æœæ²¡æœ‰åŒ¹é…çš„ï¼Œå°± fallback åˆ°æ‰€æœ‰è¡¨æƒ…åŒ…
                if (suitableStickers.length === 0) {
                    suitableStickers = state.aiStickers;
                }
            }
            
            // 4. éšæœºé€‰æ‹©å¹¶å‘é€
            const randomIndex = Math.floor(Math.random() * suitableStickers.length);
            const selectedSticker = suitableStickers[randomIndex];
            
            addMessage('ai', `[è¡¨æƒ…åŒ…: ${selectedSticker.keyword}]`, 'sticker', {
                imageData: selectedSticker.imageData,
                keyword: selectedSticker.keyword
            });
        }

        // ==================== åŠ å·èœå•åŠŸèƒ½ ====================
        function togglePlusMenu() {
            const plusMenu = document.getElementById('wechatPlusMenu');
            state.isPlusMenuOpen = !state.isPlusMenuOpen;
            
            if (state.isPlusMenuOpen) {
                plusMenu.classList.add('show');
            } else {
                plusMenu.classList.remove('show');
            }
            
            // éšè—å…¶ä»–é¢æ¿
            if (state.isPlusMenuOpen) {
                toggleStickerPanel(false);
            }
        }

        function hidePlusMenu() {
            const plusMenu = document.getElementById('wechatPlusMenu');
            plusMenu.classList.remove('show');
            state.isPlusMenuOpen = false;
        }

        // ==================== è®¾ç½®é¡µé¢åŠŸèƒ½ ====================
        function openSettings() {
            document.getElementById('mainContainer').classList.add('settings-open');
            state.isSettingsOpen = true;
            updateSettingsForm();
        }

        function closeSettings() {
            document.getElementById('mainContainer').classList.remove('settings-open');
            state.isSettingsOpen = false;
        }

        function initializeSettingsPage() {
            const settingsContent = document.getElementById('settingsContent');
            if (!settingsContent) return;
            
            // ç”Ÿæˆè®¾ç½®é¡µé¢HTML
            settingsContent.innerHTML = generateSettingsHTML();
            
            // ç»‘å®šè®¾ç½®é¡µé¢äº‹ä»¶
            bindSettingsEvents();
            
            // æ›´æ–°è¡¨å•
            updateSettingsForm();
        }

        function generateSettingsHTML() {
            return `
                <!-- å¤´åƒè®¾ç½®å¡ç‰‡ -->
                <div class="setting-card">
                    <div class="card-title">
                        <i class="fas fa-user-circle"></i> å¤´åƒè®¾ç½®
                    </div>
                    
                    <div class="avatar-section">
                        <!-- AIå¤´åƒ -->
                        <div class="avatar-upload">
                            <div class="avatar-preview" id="ai-avatar-preview">
                                <div class="avatar-default-icon">åŒ—</div>
                            </div>
                            <div class="avatar-upload-btns">
                                <button class="avatar-upload-btn" id="upload-ai-btn">
                                    <i class="fas fa-upload"></i> è®¾ç½®AIå¤´åƒ
                                </button>
                                <div class="avatar-color-row">
                                    <span class="color-label">å¤´åƒé¢œè‰²ï¼š</span>
                                    <input type="color" id="ai-avatar-color" class="color-picker-input" value="${state.config.aiColor}">
                                    <div class="color-preview" id="ai-color-preview" style="background-color: ${state.config.aiColor};"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ç”¨æˆ·å¤´åƒ -->
                        <div class="avatar-upload">
                            <div class="avatar-preview" id="user-avatar-preview">
                                <div class="avatar-default-icon">æ¬¢</div>
                            </div>
                            <div class="avatar-upload-btns">
                                <button class="avatar-upload-btn" id="upload-user-btn">
                                    <i class="fas fa-upload"></i> è®¾ç½®æˆ‘çš„å¤´åƒ
                                </button>
                                <div class="avatar-color-row">
                                    <span class="color-label">å¤´åƒé¢œè‰²ï¼š</span>
                                    <input type="color" id="user-avatar-color" class="color-picker-input" value="${state.config.userColor}">
                                    <div class="color-preview" id="user-color-preview" style="background-color: ${state.config.userColor};"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- è¡¨æƒ…åŒ…ç®¡ç†å¡ç‰‡ -->
                <div class="setting-card">
                    <div class="card-title">
                        <i class="fas fa-sticky-note"></i> å›¾ç‰‡è¡¨æƒ…åŒ…ç®¡ç†
                    </div>
                    
                    <div class="sticker-type-select">
                        <button class="sticker-type-btn active" data-type="user">
                            <i class="fas fa-user"></i> æˆ‘çš„è¡¨æƒ…åŒ…
                        </button>
                        <button class="sticker-type-btn" data-type="ai">
                            <i class="fas fa-robot"></i> AIè¡¨æƒ…åŒ…
                        </button>
                    </div>
                    
                    <div class="sticker-upload-area" id="sticker-upload-area">
                        <div class="sticker-upload-icon">
                            <i class="fas fa-cloud-upload-alt"></i>
                        </div>
                        <div class="sticker-upload-text">
                            ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡è¡¨æƒ…åŒ…
                        </div>
                        <div class="sticker-upload-hint">
                            æ”¯æŒJPGã€PNGæ ¼å¼ï¼Œå»ºè®®å°ºå¯¸ï¼š100Ã—100åƒç´ 
                        </div>
                    </div>
                    
                    <div id="sticker-name-input" style="display: none;">
                        <div class="input-group">
                            <label class="input-label">
                                <i class="fas fa-tag"></i> è¡¨æƒ…åŒ…åç§°
                            </label>
                            <input type="text" class="input-field" id="sticker-name" 
                                   placeholder="ç»™è¡¨æƒ…åŒ…èµ·ä¸ªåå­—..." maxlength="20">
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 10px;">
                            <button class="wechat-btn" id="cancel-sticker" style="flex: 1; background: #95a5a6;">å–æ¶ˆ</button>
                            <button class="wechat-btn" id="save-sticker" style="flex: 1;" disabled>ä¿å­˜</button>
                        </div>
                    </div>
                    
                    <div id="sticker-grid-container">
                        <div class="sticker-grid" id="user-sticker-grid">
                            <!-- ç”¨æˆ·è¡¨æƒ…åŒ…å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                        </div>
                        <div class="sticker-grid" id="ai-sticker-grid" style="display: none;">
                            <!-- AIè¡¨æƒ…åŒ…å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                        </div>
                    </div>
                </div>

                <!-- åŸºæœ¬ä¿¡æ¯å¡ç‰‡ -->
                <div class="setting-card">
                    <div class="card-title">
                        <i class="fas fa-info-circle"></i> åŸºæœ¬ä¿¡æ¯
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label">
                            <i class="fas fa-robot"></i> AIæ˜µç§°
                        </label>
                        <input type="text" class="input-field" id="settings-ai-name" 
                               placeholder="ç»™AIä¼™ä¼´èµ·ä¸ªåå­—..." maxlength="20" value="${state.config.aiName}">
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label">
                            <i class="fas fa-user-tag"></i> æˆ‘çš„æ˜µç§°
                        </label>
                        <input type="text" class="input-field" id="settings-user-name" 
                               placeholder="è¾“å…¥ä½ çš„æ˜µç§°..." maxlength="20" value="${state.config.userName}">
                    </div>
                </div>

                <!-- AIäººè®¾å¡ç‰‡ -->
                <div class="setting-card">
                    <div class="card-title">
                        <i class="fas fa-magic"></i> AIäººè®¾è®¾ç½®
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label">
                            <i class="fas fa-comment-dots"></i> æ€§æ ¼æè¿°
                        </label>
                        <textarea class="input-field" id="settings-ai-personality" 
                                  rows="4" placeholder="æè¿°AIçš„æ€§æ ¼ç‰¹ç‚¹..." maxlength="500">${state.config.aiPersonality}</textarea>
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label">
                            <i class="fas fa-brain"></i> è®°å¿†æ·±åº¦
                        </label>
                        <select class="input-field" id="settings-memory-depth">
                            <option value="5" ${state.config.memoryDepth === 5 ? 'selected' : ''}>çŸ­æœŸè®°å¿†ï¼ˆæœ€è¿‘5æ¡å¯¹è¯ï¼‰</option>
                            <option value="10" ${state.config.memoryDepth === 10 ? 'selected' : ''}>ä¸­ç­‰è®°å¿†ï¼ˆæœ€è¿‘10æ¡å¯¹è¯ï¼‰</option>
                            <option value="20" ${state.config.memoryDepth === 20 ? 'selected' : ''}>é•¿æœŸè®°å¿†ï¼ˆæœ€è¿‘20æ¡å¯¹è¯ï¼‰</option>
                            <option value="50" ${state.config.memoryDepth === 50 ? 'selected' : ''}>è¶…é•¿è®°å¿†ï¼ˆæœ€è¿‘50æ¡å¯¹è¯ï¼‰</option>
                        </select>
                    </div>
                </div>

                <!-- èŠå¤©èƒŒæ™¯å¡ç‰‡ -->
                <div class="setting-card">
                    <div class="card-title">
                        <i class="fas fa-palette"></i> èŠå¤©èƒŒæ™¯
                    </div>
                    
                    <div class="bg-grid">
                        <div class="bg-option ${state.config.bgType === 'color' && state.config.chatBackground === '#f5f5f5' ? 'selected' : ''}" 
                             data-bg="#f5f5f5" data-type="color" style="background: #f5f5f5;">
                            <div class="bg-check"><i class="fas fa-check"></i></div>
                        </div>
                        <div class="bg-option ${state.config.bgType === 'color' && state.config.chatBackground === '#ffffff' ? 'selected' : ''}" 
                             data-bg="#ffffff" data-type="color" style="background: #ffffff; border: 1px solid #eee;">
                            <div class="bg-check"><i class="fas fa-check"></i></div>
                        </div>
                        <div class="bg-option ${state.config.bgType === 'color' && state.config.chatBackground === '#f0f8ff' ? 'selected' : ''}" 
                             data-bg="#f0f8ff" data-type="color" style="background: #f0f8ff;">
                            <div class="bg-check"><i class="fas fa-check"></i></div>
                        </div>
                        <div class="bg-option ${state.config.bgType === 'gradient' && state.config.chatBackground.includes('linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)') ? 'selected' : ''}" 
                             data-bg="linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)" data-type="gradient" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);">
                            <div class="bg-check"><i class="fas fa-check"></i></div>
                        </div>
                        <div class="bg-option ${state.config.bgType === 'gradient' && state.config.chatBackground.includes('linear-gradient(135deg, #fad0c4 0%, #ffd1ff 100%)') ? 'selected' : ''}" 
                             data-bg="linear-gradient(135deg, #fad0c4 0%, #ffd1ff 100%)" data-type="gradient" style="background: linear-gradient(135deg, #fad0c4 0%, #ffd1ff 100%);">
                            <div class="bg-check"><i class="fas fa-check"></i></div>
                        </div>
                        <div class="bg-option bg-custom-upload" id="custom-bg-btn">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <span>ä¸Šä¼ å›¾ç‰‡</span>
                        </div>
                    </div>
                </div>
            `;
        }

        function bindSettingsEvents() {
            // å¤´åƒä¸Šä¼ 
            document.getElementById('upload-ai-btn')?.addEventListener('click', () => {
                document.getElementById('aiAvatarInput').click();
            });
            
            document.getElementById('upload-user-btn')?.addEventListener('click', () => {
                document.getElementById('userAvatarInput').click();
            });
            
            // å¤´åƒé¢œè‰²é€‰æ‹©
            document.getElementById('ai-avatar-color')?.addEventListener('input', function() {
                document.getElementById('ai-color-preview').style.backgroundColor = this.value;
            });
            
            document.getElementById('user-avatar-color')?.addEventListener('input', function() {
                document.getElementById('user-color-preview').style.backgroundColor = this.value;
            });
            
            // å¤´åƒæ–‡ä»¶ä¸Šä¼ 
            document.getElementById('aiAvatarInput')?.addEventListener('change', function(e) {
                handleSettingsImageUpload(e, 'aiAvatar', 'ai-avatar-preview');
            });
            
            document.getElementById('userAvatarInput')?.addEventListener('change', function(e) {
                handleSettingsImageUpload(e, 'userAvatar', 'user-avatar-preview');
            });
            
            // è¡¨æƒ…åŒ…ç®¡ç†
            bindStickerSettingsEvents();
            
            // èƒŒæ™¯é€‰æ‹©
            bindBackgroundSettingsEvents();
            
            // ä¿å­˜è®¾ç½®
            document.getElementById('saveSettingsBtn')?.addEventListener('click', saveSettings);
        }

        function handleSettingsImageUpload(e, configKey, previewId) {
            const file = e.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                showToast('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
                return;
            }
            
            if (file.size > 2 * 1024 * 1024) {
                showToast('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡2MB');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const dataURL = e.target.result;
                
                // æ›´æ–°é¢„è§ˆ
                const preview = document.getElementById(previewId);
                preview.innerHTML = `<img src="${dataURL}" alt="å¤´åƒ" style="width:100%;height:100%;object-fit:cover;">`;
                
                // ä¿å­˜åˆ°ä¸´æ—¶é…ç½®
                state.tempConfig[configKey] = dataURL;
                
                showToast('å¤´åƒå·²ä¸Šä¼ ï¼Œç‚¹å‡»ä¿å­˜è®¾ç½®ç”Ÿæ•ˆ');
            };
            reader.readAsDataURL(file);
        }

        function bindStickerSettingsEvents() {
            const stickerUploadArea = document.getElementById('sticker-upload-area');
            const stickerFileInput = document.getElementById('stickerFileInput');
            const stickerNameInput = document.getElementById('sticker-name-input');
            const stickerNameField = document.getElementById('sticker-name');
            const saveStickerBtn = document.getElementById('save-sticker');
            const cancelStickerBtn = document.getElementById('cancel-sticker');
            const stickerTypeBtns = document.querySelectorAll('.sticker-type-btn');
            const userStickerGrid = document.getElementById('user-sticker-grid');
            const aiStickerGrid = document.getElementById('ai-sticker-grid');
            
            let currentStickerType = 'user';
            let pendingStickerData = null;
            
            // è¡¨æƒ…åŒ…ç±»å‹åˆ‡æ¢
            stickerTypeBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    stickerTypeBtns.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    currentStickerType = this.dataset.type;
                    
                    // åˆ‡æ¢æ˜¾ç¤ºçš„ç½‘æ ¼
                    if (currentStickerType === 'user') {
                        userStickerGrid.style.display = 'grid';
                        aiStickerGrid.style.display = 'none';
                    } else {
                        userStickerGrid.style.display = 'none';
                        aiStickerGrid.style.display = 'grid';
                    }
                    
                    // åŠ è½½å¯¹åº”ç±»å‹çš„è¡¨æƒ…åŒ…
                    loadSettingsStickers(currentStickerType);
                });
            });
            
            // ç‚¹å‡»ä¸Šä¼ åŒºåŸŸ
            if (stickerUploadArea) {
                stickerUploadArea.addEventListener('click', function() {
                    stickerFileInput.click();
                });
            }
            
            // é€‰æ‹©æ–‡ä»¶
            if (stickerFileInput) {
                stickerFileInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    if (!file.type.startsWith('image/')) {
                        showToast('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶ï¼');
                        return;
                    }
                    
                    if (file.size > 2 * 1024 * 1024) {
                        showToast('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡2MBï¼');
                        return;
                    }
                    
                    // è¯»å–å›¾ç‰‡
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        pendingStickerData = e.target.result;
                        stickerNameInput.style.display = 'block';
                        stickerNameField.value = '';
                        stickerNameField.focus();
                    };
                    reader.readAsDataURL(file);
                });
            }
            
            // å–æ¶ˆä¿å­˜è¡¨æƒ…åŒ…
            if (cancelStickerBtn) {
                cancelStickerBtn.addEventListener('click', function() {
                    stickerNameInput.style.display = 'none';
                    pendingStickerData = null;
                    stickerFileInput.value = '';
                });
            }
            
            // ä¿å­˜è¡¨æƒ…åŒ…
            if (saveStickerBtn) {
                saveStickerBtn.addEventListener('click', function() {
                    const stickerName = stickerNameField.value.trim();
                    if (!stickerName) {
                        showToast('è¯·è¾“å…¥è¡¨æƒ…åŒ…åç§°ï¼');
                        return;
                    }
                    
                    if (!pendingStickerData) {
                        showToast('è¯·å…ˆé€‰æ‹©å›¾ç‰‡ï¼');
                        return;
                    }
                    
                    const newSticker = {
                        id: Date.now().toString(),
                        keyword: stickerName,
                        imageData: pendingStickerData,
                        uploadTime: new Date().toISOString()
                    };
                    
                    if (currentStickerType === 'user') {
                        state.userStickers.push(newSticker);
                    } else {
                        state.aiStickers.push(newSticker);
                    }
                    
                    // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                    saveAllData();
                    
                    // æ›´æ–°ç•Œé¢
                    stickerNameInput.style.display = 'none';
                    stickerNameField.value = '';
                    pendingStickerData = null;
                    stickerFileInput.value = '';
                    
                    // é‡æ–°åŠ è½½è¡¨æƒ…åŒ…
                    loadSettingsStickers(currentStickerType);
                    
                    showToast('è¡¨æƒ…åŒ…å·²ä¿å­˜ï¼');
                });
            }
            
            // è¡¨æƒ…åŒ…åç§°è¾“å…¥å˜åŒ–
            if (stickerNameField) {
                stickerNameField.addEventListener('input', function() {
                    saveStickerBtn.disabled = !this.value.trim();
                });
            }
            
            // åˆå§‹åŒ–åŠ è½½ç”¨æˆ·è¡¨æƒ…åŒ…
            loadSettingsStickers('user');
        }

        function loadSettingsStickers(type) {
            const stickers = type === 'user' ? state.userStickers : state.aiStickers;
            const grid = type === 'user' ? document.getElementById('user-sticker-grid') : document.getElementById('ai-sticker-grid');
            
            if (!grid) return;
            
            grid.innerHTML = '';
            
            if (stickers.length === 0) {
                grid.innerHTML = `
                    <div class="empty-sticker">
                        <i class="fas fa-plus-circle"></i>
                        <p>æš‚æ— è¡¨æƒ…åŒ…</p>
                    </div>
                `;
                return;
            }
            
            stickers.forEach(sticker => {
                const stickerItem = document.createElement('div');
                stickerItem.className = 'sticker-item';
                stickerItem.innerHTML = `
                    <img src="${sticker.imageData}" alt="${sticker.keyword}">
                    <button class="delete-btn" onclick="deleteSticker('${sticker.id}', '${type}')">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                grid.appendChild(stickerItem);
            });
        }

        // åˆ é™¤è¡¨æƒ…åŒ…å‡½æ•°ï¼ˆæš´éœ²ç»™å…¨å±€ï¼‰
        window.deleteSticker = function(stickerId, stickerType) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤è¿™ä¸ª${stickerType === 'ai' ? 'AI' : ''}è¡¨æƒ…åŒ…å—ï¼Ÿ`)) return;
            
            if (stickerType === 'user') {
                state.userStickers = state.userStickers.filter(sticker => sticker.id !== stickerId);
            } else {
                state.aiStickers = state.aiStickers.filter(sticker => sticker.id !== stickerId);
            }
            
            // ä¿å­˜æ•°æ®
            saveAllData();
            
            // é‡æ–°åŠ è½½è¡¨æƒ…åŒ…
            loadSettingsStickers(stickerType);
            
            // å¦‚æœè¡¨æƒ…åŒ…é¢æ¿æ‰“å¼€ï¼Œä¹Ÿæ›´æ–°å®ƒ
            if (state.isStickerPanelOpen) {
                updateStickerPanel();
            }
            
            showToast('è¡¨æƒ…åŒ…å·²åˆ é™¤');
        };

        function bindBackgroundSettingsEvents() {
            const bgOptions = document.querySelectorAll('.bg-option');
            const customBgBtn = document.getElementById('custom-bg-btn');
            const bgImageInput = document.getElementById('bgImageInput');
            
            // èƒŒæ™¯é€‰é¡¹ç‚¹å‡»
            bgOptions.forEach(option => {
                option.addEventListener('click', function() {
                    if (this === customBgBtn) {
                        bgImageInput.click();
                        return;
                    }
                    
                    // æ›´æ–°é€‰ä¸­çŠ¶æ€
                    bgOptions.forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    
                    const bgValue = this.getAttribute('data-bg');
                    const bgType = this.getAttribute('data-type');
                    
                    // ä¿å­˜åˆ°ä¸´æ—¶é…ç½®
                    state.tempConfig.chatBackground = bgValue;
                    state.tempConfig.bgType = bgType;
                    
                    // æ¸…é™¤ä¸´æ—¶èƒŒæ™¯å›¾ç‰‡
                    delete state.tempConfig.bgImage;
                });
            });
            
            // è‡ªå®šä¹‰èƒŒæ™¯ä¸Šä¼ 
            if (bgImageInput) {
                bgImageInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    if (!file.type.startsWith('image/')) {
                        showToast('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
                        return;
                    }
                    
                    if (file.size > 2 * 1024 * 1024) {
                        showToast('èƒŒæ™¯å›¾ç‰‡ä¸èƒ½è¶…è¿‡2MB');
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        // æ›´æ–°é€‰ä¸­çŠ¶æ€
                        bgOptions.forEach(opt => opt.classList.remove('selected'));
                        
                        // ä¿å­˜åˆ°ä¸´æ—¶é…ç½®
                        state.tempConfig.chatBackground = e.target.result;
                        state.tempConfig.bgType = 'image';
                        
                        showToast('èƒŒæ™¯å›¾ç‰‡å·²ä¸Šä¼ ï¼Œç‚¹å‡»ä¿å­˜è®¾ç½®ç”Ÿæ•ˆ');
                    };
                    reader.readAsDataURL(file);
                });
            }
        }

        function updateSettingsForm() {
            // æ›´æ–°å¤´åƒé¢„è§ˆ
            updateSettingsAvatarPreviews();
            
            // æ›´æ–°é¢œè‰²é¢„è§ˆ
            updateSettingsColorPreviews();
            
            // æ›´æ–°è¡¨æƒ…åŒ…
            loadSettingsStickers('user');
        }

        function updateSettingsAvatarPreviews() {
            // AIå¤´åƒé¢„è§ˆ
            const aiPreview = document.getElementById('ai-avatar-preview');
            if (state.config.aiAvatar && state.config.aiAvatar.startsWith('data:image')) {
                aiPreview.innerHTML = `<img src="${state.config.aiAvatar}" alt="AIå¤´åƒ" style="width:100%;height:100%;object-fit:cover;">`;
            }
            
            // ç”¨æˆ·å¤´åƒé¢„è§ˆ
            const userPreview = document.getElementById('user-avatar-preview');
            if (state.config.userAvatar && state.config.userAvatar.startsWith('data:image')) {
                userPreview.innerHTML = `<img src="${state.config.userAvatar}" alt="ç”¨æˆ·å¤´åƒ" style="width:100%;height:100%;object-fit:cover;">`;
            }
        }

        function updateSettingsColorPreviews() {
            const aiColorPreview = document.getElementById('ai-color-preview');
            const userColorPreview = document.getElementById('user-color-preview');
            
            if (aiColorPreview) {
                aiColorPreview.style.backgroundColor = state.config.aiColor;
            }
            
            if (userColorPreview) {
                userColorPreview.style.backgroundColor = state.config.userColor;
            }
        }

        function saveSettings() {
            // è·å–è¡¨å•å€¼
            const aiName = document.getElementById('settings-ai-name')?.value.trim() || state.config.aiName;
            const userName = document.getElementById('settings-user-name')?.value.trim() || state.config.userName;
            const aiPersonality = document.getElementById('settings-ai-personality')?.value.trim() || state.config.aiPersonality;
            const memoryDepth = parseInt(document.getElementById('settings-memory-depth')?.value) || state.config.memoryDepth;
            const aiColor = document.getElementById('ai-avatar-color')?.value || state.config.aiColor;
            const userColor = document.getElementById('user-avatar-color')?.value || state.config.userColor;
            
            // æ›´æ–°é…ç½®
            state.config.aiName = aiName;
            state.config.userName = userName;
            state.config.aiPersonality = aiPersonality;
            state.config.memoryDepth = memoryDepth;
            state.config.aiColor = aiColor;
            state.config.userColor = userColor;
            
            // åº”ç”¨ä¸´æ—¶é…ç½®ï¼ˆä¸Šä¼ çš„å¤´åƒå’ŒèƒŒæ™¯ï¼‰
            if (state.tempConfig.aiAvatar) {
                state.config.aiAvatar = state.tempConfig.aiAvatar;
            }
            if (state.tempConfig.userAvatar) {
                state.config.userAvatar = state.tempConfig.userAvatar;
            }
            if (state.tempConfig.chatBackground) {
                state.config.chatBackground = state.tempConfig.chatBackground;
                state.config.bgType = state.tempConfig.bgType || 'color';
            }
            
            // æ¸…ç©ºä¸´æ—¶é…ç½®
            state.tempConfig = {};
            
            // ä¿å­˜æ‰€æœ‰æ•°æ®
            saveAllData();
            
            // æ›´æ–°UI
            updateAIName();
            applyBackground();
            
            // å…³é—­è®¾ç½®é¡µé¢
            closeSettings();
            
            showToast('è®¾ç½®å·²ä¿å­˜ï¼');
        }

        // ==================== è¾…åŠ©å‡½æ•° ====================
        function showTypingIndicator() {
            const chatContent = document.querySelector('.chat-content-wrapper');
            if (!chatContent) return;
            
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message message-ai';
            typingDiv.id = 'typingIndicator';
            
            typingDiv.innerHTML = `
                <div class="message-content-wrapper">
                    ${getAvatarContent('ai')}
                    <div class="typing-indicator">
                                                <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            `;
            
            // æ·»åŠ åˆ°èŠå¤©åŒºåŸŸ
            chatContent.appendChild(typingDiv);
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            autoScrollToBottom();
        }
    

    function hideTypingIndicator() {
        const typingIndicator = document.getElementById('typingIndicator');
        if (typingIndicator) {
            typingIndicator.remove();
        }
    }

    // ==================== æ¬¢è¿æ¶ˆæ¯ ====================
    function showWelcomeMessage() {
        const hasHistory = state.conversationHistory.length > 0;
        if (hasHistory) return;
        
        const greetings = [
            `å—¨ ${state.config.userName}ï¼Œä»Šå¤©è¿‡å¾—æ€ä¹ˆæ ·ï¼Ÿ`,
            `å®å®ç»ˆäºæ¥å•¦ï½æƒ³æˆ‘æ²¡ï¼Ÿ`,
            `ä»Šå¤©å¿™å•¥å‘¢ï¼Œè·Ÿæˆ‘è¯´è¯´`,
            `åœ¨å‘¢åœ¨å‘¢ï¼Œä¸€ç›´ç­‰ä½ `,
            `æƒ³ä½ äº† ${state.config.userName} ğŸ’•`
        ];
        
        const randomGreeting = greetings[Math.floor(Math.random() * greetings.length)];
        
        setTimeout(() => {
            addMessage('ai', randomGreeting);
        }, 500);
    }

    // ==================== å·¥å…·å‡½æ•° ====================
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function autoScrollToBottom() {
        const chatContent = document.getElementById('chatContent');
        if (chatContent) {
            setTimeout(() => {
                chatContent.scrollTop = chatContent.scrollHeight;
            }, 100);
        }
    }

    function showToast(message) {
        const existingToast = document.querySelector('.beiming-toast');
        if (existingToast) {
            existingToast.remove();
        }
        
        const toast = document.createElement('div');
        toast.className = 'beiming-toast';
        toast.textContent = message;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            if (toast.parentNode) {
                toast.style.opacity = '0';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.remove();
                    }
                }, 300);
            }
        }, 2000);
    }

    // ==================== é¡µé¢åŠŸèƒ½å‡½æ•° ====================
    function openSettings() {
        document.getElementById('mainContainer').classList.add('settings-open');
        state.isSettingsOpen = true;
        updateSettingsForm();
    }

    function closeSettings() {
        document.getElementById('mainContainer').classList.remove('settings-open');
        state.isSettingsOpen = false;
    }

    // ==================== æ—¶é—´æ˜¾ç¤º ====================
    function updateTimeTag() {
        const now = new Date();
        const hour = now.getHours();
        let timeString;
        
        if (hour < 6) {
            timeString = 'å‡Œæ™¨';
        } else if (hour < 12) {
            timeString = 'ä¸Šåˆ';
        } else if (hour < 13) {
            timeString = 'ä¸­åˆ';
        } else if (hour < 18) {
            timeString = 'ä¸‹åˆ';
        } else if (hour < 21) {
            timeString = 'æ™šä¸Š';
        } else {
            timeString = 'æ·±å¤œ';
        }
        
        const timeTag = document.getElementById('currentTime');
        if (timeTag) {
            timeTag.textContent = timeString;
        }
    }

    // åˆå§‹åŒ–æ—¶é—´æ ‡ç­¾
    updateTimeTag();
    setInterval(updateTimeTag, 60000);

    // ==================== çª—å£å¤§å°è°ƒæ•´ ====================
    function handleResize() {
        const isMobile = window.innerWidth <= 768;
        
        // åœ¨ç§»åŠ¨è®¾å¤‡ä¸Šè‡ªåŠ¨å…³é—­é¢æ¿
        if (isMobile && (state.isStickerPanelOpen || state.isPlusMenuOpen)) {
            toggleStickerPanel(false);
            hidePlusMenu();
        }
    }

    window.addEventListener('resize', handleResize);
    
    // ==================== è¯­éŸ³è¾“å…¥åŠŸèƒ½ï¼ˆé¢„ç•™ï¼‰ ====================
    document.getElementById('voiceToggleBtn').addEventListener('click', function() {
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            showToast('è¯­éŸ³åŠŸèƒ½å¼€å‘ä¸­...');
        } else {
            showToast('å½“å‰æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¾“å…¥');
        }
    });

    // ==================== æ•°æ®ç»Ÿè®¡ ====================
    function showStats() {
        console.log('ğŸ“Š å½“å‰ç»Ÿè®¡:');
        console.log('- å¯¹è¯å†å²:', state.conversationHistory.length, 'æ¡');
        console.log('- å¯¹è¯è½®æ¬¡:', state.conversationRound);
        console.log('- ç”¨æˆ·è¡¨æƒ…åŒ…:', state.userStickers.length, 'ä¸ª');
        console.log('- AIè¡¨æƒ…åŒ…:', state.aiStickers.length, 'ä¸ª');
        console.log('- APIè°ƒç”¨:', state.apiStats.successCalls, 'æˆåŠŸ', state.apiStats.failedCalls, 'å¤±è´¥');
        console.log('- å½“å‰é…ç½®:', state.config);
    }

    // å¼€å‘è€…å¿«æ·é”®ï¼šæŒ‰Ctrl+Shift+Sæ˜¾ç¤ºç»Ÿè®¡
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey && e.shiftKey && e.key === 'S') {
            e.preventDefault();
            showStats();
        }
    });

    // å¯¼å‡ºçŠ¶æ€åˆ°å…¨å±€ï¼ˆä¾›è°ƒè¯•ï¼‰
    window.beimingState = state;
    window.beimingConfig = CONFIG;

</script>

</body>
</html>